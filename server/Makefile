# Queen Message Queue - C++ Implementation
# Requires C++17 or later

CXX = g++
CXXFLAGS = -std=c++17 -O3 -Wall -Wextra -pthread -DWITH_OPENSSL=1
# Automatic dependency generation
DEPFLAGS = -MMD -MP
# Auto-detect include and library paths
UNAME_S := $(shell uname -s)
ifeq ($(UNAME_S),Darwin)
    # macOS - check for Homebrew paths
    BREW_PREFIX := $(shell brew --prefix 2>/dev/null || echo /usr/local)
    PG_CONFIG := $(shell which pg_config 2>/dev/null || echo "")
    ifneq ($(PG_CONFIG),)
        PG_INCLUDES := $(shell $(PG_CONFIG) --includedir)
        PG_LIBS := $(shell $(PG_CONFIG) --libdir)
    else
        # Check for versioned PostgreSQL (e.g., postgresql@14)
        PG_VERSION_DIR := $(shell find $(BREW_PREFIX)/include -name "postgresql@*" -type d 2>/dev/null | head -1)
        ifneq ($(PG_VERSION_DIR),)
            PG_INCLUDES := $(PG_VERSION_DIR) $(BREW_PREFIX)/include/postgresql $(BREW_PREFIX)/opt/postgresql/include
            PG_VERSION := $(shell basename $(PG_VERSION_DIR))
            PG_LIBS := $(BREW_PREFIX)/lib $(BREW_PREFIX)/opt/$(PG_VERSION)/lib $(BREW_PREFIX)/opt/postgresql/lib
        else
            PG_INCLUDES := $(BREW_PREFIX)/include/postgresql $(BREW_PREFIX)/opt/postgresql/include
            PG_LIBS := $(BREW_PREFIX)/lib $(BREW_PREFIX)/opt/postgresql/lib
        endif
    endif
    SSL_INCLUDES := $(BREW_PREFIX)/opt/openssl@3/include $(BREW_PREFIX)/include $(BREW_PREFIX)/opt/openssl/include
    SSL_LIBS := $(BREW_PREFIX)/opt/openssl@3/lib $(BREW_PREFIX)/lib $(BREW_PREFIX)/opt/openssl/lib
    # libuv from vendor (built from source) - use static library
    UV_INCLUDES := ./vendor/libuv/include
    UV_STATIC_LIB := ./vendor/libuv/build/libuv.a
    # jwt-cpp header-only library
    JWTCPP_INCLUDES := ./vendor/jwt-cpp/include
    INCLUDES = -I./include -I./vendor -I./vendor/uSockets/src -I../lib $(addprefix -I,$(PG_INCLUDES)) $(addprefix -I,$(SSL_INCLUDES)) -I$(UV_INCLUDES) -I$(JWTCPP_INCLUDES)
    LIBS = $(addprefix -L,$(PG_LIBS)) $(addprefix -L,$(SSL_LIBS)) -lpq -lssl -lcrypto -lz $(UV_STATIC_LIB)
else
    # Linux - libuv from vendor (built from source) - use static library
    UV_INCLUDES := ./vendor/libuv/include
    UV_STATIC_LIB := ./vendor/libuv/build/libuv.a
    # jwt-cpp header-only library
    JWTCPP_INCLUDES := ./vendor/jwt-cpp/include
    INCLUDES = -I./include -I./vendor -I./vendor/uSockets/src -I../lib -I/usr/include/postgresql -I/usr/local/include/postgresql -I$(UV_INCLUDES) -I$(JWTCPP_INCLUDES)
    LIBS = -lpq -lssl -lcrypto -lz $(UV_STATIC_LIB)
endif

# Directories
SRC_DIR = src
INCLUDE_DIR = include
VENDOR_DIR = vendor
BUILD_DIR = build
BIN_DIR = bin

# Source files - Acceptor/Worker pattern (cross-platform)
SOURCES = $(SRC_DIR)/main_acceptor.cpp \
          $(SRC_DIR)/acceptor_server.cpp \
          $(wildcard $(SRC_DIR)/database/*.cpp) \
          $(wildcard $(SRC_DIR)/managers/*.cpp) \
          $(wildcard $(SRC_DIR)/services/*.cpp) \
          $(wildcard $(SRC_DIR)/routes/*.cpp) \
          $(wildcard $(SRC_DIR)/auth/*.cpp)
OBJECTS = $(SOURCES:$(SRC_DIR)/%.cpp=$(BUILD_DIR)/%.o)
DEPS = $(OBJECTS:.o=.d)

# uSockets source files (C and C++ files)
# Note: Make wildcard doesn't support ** so we need to explicitly list subdirectories
USOCKETS_C_SOURCES = $(wildcard $(VENDOR_DIR)/uSockets/src/*.c) \
                     $(wildcard $(VENDOR_DIR)/uSockets/src/crypto/*.c) \
                     $(wildcard $(VENDOR_DIR)/uSockets/src/eventing/*.c) \
                     $(wildcard $(VENDOR_DIR)/uSockets/src/io_uring/*.c)
USOCKETS_CPP_SOURCES = $(wildcard $(VENDOR_DIR)/uSockets/src/*.cpp) \
                       $(wildcard $(VENDOR_DIR)/uSockets/src/crypto/*.cpp) \
                       $(wildcard $(VENDOR_DIR)/uSockets/src/eventing/*.cpp)
USOCKETS_C_OBJECTS = $(patsubst $(VENDOR_DIR)/uSockets/src/%.c,$(BUILD_DIR)/usockets/%.o,$(USOCKETS_C_SOURCES))
USOCKETS_CPP_OBJECTS = $(patsubst $(VENDOR_DIR)/uSockets/src/%.cpp,$(BUILD_DIR)/usockets/%.o,$(USOCKETS_CPP_SOURCES))
USOCKETS_OBJECTS = $(USOCKETS_C_OBJECTS) $(USOCKETS_CPP_OBJECTS)

# Target executable (Acceptor/Worker pattern - cross-platform)
TARGET = $(BIN_DIR)/queen-server

# Header-only dependencies (will be downloaded)
UWS_URL = https://github.com/uNetworking/uWebSockets/archive/refs/heads/master.zip
USOCKETS_URL = https://github.com/uNetworking/uSockets/archive/refs/heads/master.zip
NLOHMANN_JSON_URL = https://github.com/nlohmann/json/releases/download/v3.11.3/json.hpp
CPPHTTPLIB_URL = https://raw.githubusercontent.com/yhirose/cpp-httplib/master/httplib.h
SPDLOG_URL = https://github.com/gabime/spdlog/archive/refs/tags/v1.14.1.zip
LIBUV_URL = https://github.com/libuv/libuv/archive/refs/tags/v1.48.0.zip
JWTCPP_URL = https://github.com/Thalhammer/jwt-cpp/archive/refs/tags/v0.7.0.zip

.PHONY: all clean deps setup test build-only debug-objects

all: setup deps $(TARGET)

# Build without downloading dependencies (assumes deps already exist)
build-only: setup $(TARGET)

# Create directory structure
setup:
	@mkdir -p $(BUILD_DIR) $(BIN_DIR) $(INCLUDE_DIR) $(VENDOR_DIR)
	@mkdir -p $(SRC_DIR)/database $(SRC_DIR)/managers $(SRC_DIR)/routes $(SRC_DIR)/utils $(SRC_DIR)/auth

# Download and setup dependencies
deps: $(VENDOR_DIR)/.deps_ready

$(VENDOR_DIR)/.deps_ready: setup
	@echo "Setting up dependencies..."
	
	# Download nlohmann/json (single header)
	@curl -L $(NLOHMANN_JSON_URL) -o $(VENDOR_DIR)/json.hpp
	
	# Download cpp-httplib (single header for HTTP client)
	@curl -L $(CPPHTTPLIB_URL) -o $(VENDOR_DIR)/httplib.h
	
	# Download uWebSockets
	@cd $(VENDOR_DIR) && \
		curl -L $(UWS_URL) -o uws.zip && \
		unzip -qo uws.zip && \
		rm -rf uWebSockets && \
		mv uWebSockets-master uWebSockets && \
		rm uws.zip
	
	# Download uSockets (required by uWebSockets)
	@cd $(VENDOR_DIR) && \
		curl -L $(USOCKETS_URL) -o usockets.zip && \
		unzip -qo usockets.zip && \
		rm -rf uSockets && \
		mv uSockets-master uSockets && \
		rm usockets.zip
	
	# Download spdlog
	@cd $(VENDOR_DIR) && \
		curl -L $(SPDLOG_URL) -o spdlog.zip && \
		unzip -qo spdlog.zip && \
		rm -rf spdlog && \
		mv spdlog-1.14.1 spdlog && \
		rm spdlog.zip
	
	# Download and build libuv (static library)
	@echo "Building libuv..."
	@cd $(VENDOR_DIR) && \
		curl -L $(LIBUV_URL) -o libuv.zip && \
		unzip -qo libuv.zip && \
		rm -rf libuv && \
		mv libuv-1.48.0 libuv && \
		rm libuv.zip && \
		cd libuv && \
		mkdir -p build && \
		cd build && \
		cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTING=OFF -DLIBUV_BUILD_SHARED=OFF && \
		cmake --build . --target uv_a -j4
	
	# Download jwt-cpp (header-only JWT library)
	@cd $(VENDOR_DIR) && \
		curl -L $(JWTCPP_URL) -o jwt-cpp.zip && \
		unzip -qo jwt-cpp.zip && \
		rm -rf jwt-cpp && \
		mv jwt-cpp-0.7.0 jwt-cpp && \
		rm jwt-cpp.zip
	
	@touch $(VENDOR_DIR)/.deps_ready
	@echo "Dependencies ready!"

# Build queen-server (Acceptor/Worker pattern - cross-platform)
$(TARGET): $(OBJECTS) $(USOCKETS_OBJECTS)
	@echo "Linking $(TARGET) with $(words $(OBJECTS)) Queen objects and $(words $(USOCKETS_OBJECTS)) uSockets objects..."
	@$(CXX) $(OBJECTS) $(USOCKETS_OBJECTS) -o $@ $(LIBS)
	@echo "âœ… Build complete! (Acceptor/Worker pattern - works on all platforms)"

# Compile C++ source files (with automatic dependency generation)
$(BUILD_DIR)/%.o: $(SRC_DIR)/%.cpp
	@mkdir -p $(dir $@)
	@echo "Compiling $<..."
	@$(CXX) $(CXXFLAGS) $(DEPFLAGS) $(INCLUDES) -I$(VENDOR_DIR)/uWebSockets/src -I$(VENDOR_DIR)/spdlog/include -I$(VENDOR_DIR) -c $< -o $@

# Include generated dependency files (silently ignore if they don't exist yet)
-include $(DEPS)

# Compile uSockets - single rule that handles all subdirectories
# Using static pattern rules for better control
$(USOCKETS_C_OBJECTS): $(BUILD_DIR)/usockets/%.o: $(VENDOR_DIR)/uSockets/src/%.c
	@mkdir -p $(dir $@)
	@echo "Compiling uSockets C: $<"
	@gcc -O3 -c $(INCLUDES) -DWITH_OPENSSL=1 -DLIBUS_USE_OPENSSL $< -o $@

$(USOCKETS_CPP_OBJECTS): $(BUILD_DIR)/usockets/%.o: $(VENDOR_DIR)/uSockets/src/%.cpp
	@mkdir -p $(dir $@)
	@echo "Compiling uSockets C++: $<"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -DWITH_OPENSSL=1 -DLIBUS_USE_OPENSSL -c $< -o $@

# Test with existing Node.js test suite
test: $(TARGET)
	@echo "Starting C++ Queen server for testing..."
	@./$(BIN_DIR)/queen-server --port 6633 &
	@SERVER_PID=$$!; \
	sleep 2; \
	echo "Running Node.js test suite against C++ server..."; \
	cd .. && QUEEN_TEST_PORT=6633 node src/test/test-new.js; \
	TEST_RESULT=$$?; \
	kill $$SERVER_PID 2>/dev/null || true; \
	exit $$TEST_RESULT

# Clean build artifacts
clean:
	@rm -rf $(BUILD_DIR) $(BIN_DIR)
	@echo "Clean complete!"

# Clean everything including dependencies
distclean: clean
	@rm -rf $(VENDOR_DIR)
	@echo "Full clean complete!"

# Development helpers
dev: $(TARGET)
	@echo "Starting development server..."
	@./$(BIN_DIR)/queen-server --port 6632 --dev

install-deps-ubuntu:
	@sudo apt-get update
	@sudo apt-get install -y build-essential libpq-dev libssl-dev zlib1g-dev cmake curl unzip

install-deps-macos:
	@brew install postgresql openssl cmake curl unzip
	@echo "Note: You may need to set PKG_CONFIG_PATH for OpenSSL"

debug-paths:
	@echo "=== Build Configuration Debug ==="
	@echo "Operating System: $(UNAME_S)"
ifeq ($(UNAME_S),Darwin)
	@echo "Homebrew prefix: $(BREW_PREFIX)"
	@echo "pg_config: $(PG_CONFIG)"
	@echo "PostgreSQL includes: $(PG_INCLUDES)"
	@echo "PostgreSQL libs: $(PG_LIBS)"
	@echo "OpenSSL includes: $(SSL_INCLUDES)"
	@echo "OpenSSL libs: $(SSL_LIBS)"
endif
	@echo "Final INCLUDES: $(INCLUDES)"
	@echo "Final LIBS: $(LIBS)"
	@echo "================================="

debug-objects:
	@echo "=== Build Objects Debug ==="
	@echo "Queen C++ sources: $(words $(SOURCES)) files"
	@echo "Queen objects: $(words $(OBJECTS)) files"
	@echo ""
	@echo "uSockets C sources: $(words $(USOCKETS_C_SOURCES)) files"
	@echo "  $(USOCKETS_C_SOURCES)"
	@echo ""
	@echo "uSockets C++ sources: $(words $(USOCKETS_CPP_SOURCES)) files"
	@echo "  $(USOCKETS_CPP_SOURCES)"
	@echo ""
	@echo "uSockets C objects: $(words $(USOCKETS_C_OBJECTS)) files"
	@echo "  $(USOCKETS_C_OBJECTS)"
	@echo ""
	@echo "uSockets C++ objects: $(words $(USOCKETS_CPP_OBJECTS)) files"
	@echo "  $(USOCKETS_CPP_OBJECTS)"
	@echo ""
	@echo "Total uSockets objects: $(words $(USOCKETS_OBJECTS)) files"
	@echo "================================="

help:
	@echo "Queen C++ Build System"
	@echo ""
	@echo "Targets:"
	@echo "  all          - Build queen-server (downloads deps if needed)"
	@echo "  build-only   - Build without downloading deps (offline mode)"
	@echo "  deps         - Download header-only dependencies"
	@echo "  test         - Run Node.js test suite against C++ server"
	@echo "  clean        - Remove build artifacts"
	@echo "  distclean    - Remove build artifacts and dependencies"
	@echo "  dev          - Start development server"
	@echo "  debug-paths  - Show detected include/library paths"
	@echo "  debug-objects - Show source/object file counts"
	@echo ""
	@echo "Server:"
	@echo "  queen-server - Acceptor/Worker pattern (cross-platform)"
	@echo "                 - Works on macOS, Linux, Windows"
	@echo "                 - 60/60 tests passing"
	@echo "                 - 130k+ msg/s throughput"
	@echo "                 - libuv-based async event loop"
	@echo ""
	@echo "Dependencies:"
	@echo "  install-deps-ubuntu  - Install system dependencies on Ubuntu"
	@echo "  install-deps-macos   - Install system dependencies on macOS"
