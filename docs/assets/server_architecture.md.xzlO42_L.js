import{_ as n,c as a,o as e,ag as i}from"./chunks/framework.-kPtTt-D.js";const b=JSON.parse('{"title":"Server Architecture","description":"","frontmatter":{},"headers":[],"relativePath":"server/architecture.md","filePath":"server/architecture.md"}'),p={name:"server/architecture.md"};function l(r,s,t,o,h,c){return e(),a("div",null,[...s[0]||(s[0]=[i(`<h1 id="server-architecture" tabindex="-1">Server Architecture <a class="header-anchor" href="#server-architecture" aria-label="Permalink to &quot;Server Architecture&quot;">​</a></h1><p>Queen MQ uses a high-performance <strong>acceptor/worker pattern</strong> with fully asynchronous, non-blocking PostgreSQL operations for maximum throughput and minimal latency.</p><h2 id="system-overview" tabindex="-1">System Overview <a class="header-anchor" href="#system-overview" aria-label="Permalink to &quot;System Overview&quot;">​</a></h2><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>                     ┌─────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>                     │                         QUEEN SERVER                        │</span></span>
<span class="line"><span>                     └─────────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                                                  │</span></span>
<span class="line"><span>                                                  ▼</span></span>
<span class="line"><span>                     ┌─────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>                     │              ACCEPTOR (port 6632, round-robin)              │</span></span>
<span class="line"><span>                     │                    uWebSockets event loop                   │</span></span>
<span class="line"><span>                     └────────────┬───────────────┬───────────────┬────────────────┘</span></span>
<span class="line"><span>                                  │               │               │</span></span>
<span class="line"><span>          ┌───────────────────────┼───────────────┼───────────────┼────────────────────────┐</span></span>
<span class="line"><span>          │                       │               │               │                        │</span></span>
<span class="line"><span>          ▼                       ▼               ▼               ▼                        ▼</span></span>
<span class="line"><span>┌─────────────────────┐ ┌─────────────────────┐       ┌─────────────────────┐ ┌─────────────────────┐</span></span>
<span class="line"><span>│    UWS WORKER 0     │ │    UWS WORKER 1     │  ...  │   UWS WORKER N-1    │ │    UWS WORKER N     │</span></span>
<span class="line"><span>│   (event loop)      │ │   (event loop)      │       │   (event loop)      │ │   (event loop)      │</span></span>
<span class="line"><span>│                     │ │                     │       │                     │ │                     │</span></span>
<span class="line"><span>│  ┌───────────────┐  │ │  ┌───────────────┐  │       │  ┌───────────────┐  │ │  ┌───────────────┐  │</span></span>
<span class="line"><span>│  │ HTTP Handler  │  │ │  │ HTTP Handler  │  │       │  │ HTTP Handler  │  │ │  │ HTTP Handler  │  │</span></span>
<span class="line"><span>│  └───────┬───────┘  │ │  └───────┬───────┘  │       │  └───────┬───────┘  │ │  └───────┬───────┘  │</span></span>
<span class="line"><span>│          │          │ │          │          │       │          │          │ │          │          │</span></span>
<span class="line"><span>│          ▼          │ │          ▼          │       │          ▼          │ │          ▼          │</span></span>
<span class="line"><span>│  ┌───────────────┐  │ │  ┌───────────────┐  │       │  ┌───────────────┐  │ │  ┌───────────────┐  │</span></span>
<span class="line"><span>│  │  Mutex Queue  │  │ │  │  Mutex Queue  │  │       │  │  Mutex Queue  │  │ │  │  Mutex Queue  │  │</span></span>
<span class="line"><span>│  └───────┬───────┘  │ │  └───────┬───────┘  │       │  └───────┬───────┘  │ │  └───────┬───────┘  │</span></span>
<span class="line"><span>│          │          │ │          │          │       │          │          │ │          │          │</span></span>
<span class="line"><span>│          ▼          │ │          ▼          │       │          ▼          │ │          ▼          │</span></span>
<span class="line"><span>│  ┌───────────────┐  │ │  ┌───────────────┐  │       │  ┌───────────────┐  │ │  ┌───────────────┐  │</span></span>
<span class="line"><span>│  │ LIBQUEEN 0    │  │ │  │ LIBQUEEN 1    │  │       │  │ LIBQUEEN N-1  │  │ │  │ LIBQUEEN N    │  │</span></span>
<span class="line"><span>│  │ (libuv loop)  │  │ │  │ (libuv loop)  │  │       │  │ (libuv loop)  │  │ │  │ (libuv loop)  │  │</span></span>
<span class="line"><span>│  │               │  │ │  │               │  │       │  │               │  │ │  │               │  │</span></span>
<span class="line"><span>│  │ Timer (5ms)   │  │ │  │ Timer (5ms)   │  │       │  │ Timer (5ms)   │  │ │  │ Timer (5ms)   │  │</span></span>
<span class="line"><span>│  │      │        │  │ │  │      │        │  │       │  │      │        │  │ │  │      │        │  │</span></span>
<span class="line"><span>│  │      ▼        │  │ │  │      ▼        │  │       │  │      ▼        │  │ │  │      ▼        │  │</span></span>
<span class="line"><span>│  │ Microbatch    │  │ │  │ Microbatch    │  │       │  │ Microbatch    │  │ │  │ Microbatch    │  │</span></span>
<span class="line"><span>│  │      │        │  │ │  │      │        │  │       │  │      │        │  │ │  │      │        │  │</span></span>
<span class="line"><span>│  │      ▼        │  │ │  │      ▼        │  │       │  │      ▼        │  │ │  │      ▼        │  │</span></span>
<span class="line"><span>│  │ PG Pool (M)   │  │ │  │ PG Pool (M)   │  │       │  │ PG Pool (M)   │  │ │  │ PG Pool (M)   │  │</span></span>
<span class="line"><span>│  └───────────────┘  │ │  └───────────────┘  │       │  └───────────────┘  │ │  └───────────────┘  │</span></span>
<span class="line"><span>└─────────────────────┘ └─────────────────────┘       └─────────────────────┘ └─────────────────────┘</span></span>
<span class="line"><span>          │                       │               │               │                        │</span></span>
<span class="line"><span>          └───────────────────────┴───────────────┴───────────────┴────────────────────────┘</span></span>
<span class="line"><span>                                                  │</span></span>
<span class="line"><span>                                                  ▼</span></span>
<span class="line"><span>                                     ┌─────────────────────────┐</span></span>
<span class="line"><span>                                     │       PostgreSQL        │</span></span>
<span class="line"><span>                                     │    (N×M connections)    │</span></span>
<span class="line"><span>                                     └─────────────────────────┘</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><h2 id="core-components" tabindex="-1">Core Components <a class="header-anchor" href="#core-components" aria-label="Permalink to &quot;Core Components&quot;">​</a></h2><h3 id="_1-acceptor-thread" tabindex="-1">1. Acceptor Thread <a class="header-anchor" href="#_1-acceptor-thread" aria-label="Permalink to &quot;1. Acceptor Thread&quot;">​</a></h3><p>A single thread that listens on port 6632 and distributes connections to workers in round-robin fashion. It does nothing but accept TCP connections and pass sockets to workers — pure routing, no processing logic.</p><div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Acceptor distributes connections round-robin</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">acceptor-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">listen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(host, port, [](</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">auto*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> listen_socket</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // All workers registered via addChildApp()</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // uWebSockets handles round-robin internally</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="_2-uws-workers" tabindex="-1">2. uWS Workers <a class="header-anchor" href="#_2-uws-workers" aria-label="Permalink to &quot;2. uWS Workers&quot;">​</a></h3><p>Each worker is a thread with its own uWebSockets event loop. When an HTTP request arrives (e.g. push), the worker:</p><ol><li>Parses the request</li><li>Registers in ResponseRegistry (maps request_id → HTTP response)</li><li>Pushes the operation onto a mutex-protected queue</li><li><strong>Does not wait</strong> — the HTTP response will be sent when Postgres responds</li></ol><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> NUM_WORKERS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Default: 2 workers</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PORT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">6632</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # Default listening port</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="_3-libqueen-per-worker-async-database" tabindex="-1">3. libqueen (Per-Worker Async Database) <a class="header-anchor" href="#_3-libqueen-per-worker-async-database" aria-label="Permalink to &quot;3. libqueen (Per-Worker Async Database)&quot;">​</a></h3><p>This is where the magic happens. Each uWS worker has its own <strong>libqueen</strong> instance, which runs in a separate thread with its own <strong>libuv event loop</strong>. libqueen handles all PostgreSQL operations asynchronously.</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>┌─────────────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│                        libqueen instance                             │</span></span>
<span class="line"><span>│                                                                      │</span></span>
<span class="line"><span>│   ┌──────────────┐   ┌──────────────┐   ┌──────────────────┐        │</span></span>
<span class="line"><span>│   │ submit_signal│   │ batch_timer  │   │  waiting_timer   │        │</span></span>
<span class="line"><span>│   │  (uv_async)  │   │  (uv_timer)  │   │   (uv_timer)     │        │</span></span>
<span class="line"><span>│   │              │   │   5ms cycle  │   │  100ms-1000ms    │        │</span></span>
<span class="line"><span>│   └──────┬───────┘   └──────┬───────┘   └────────┬─────────┘        │</span></span>
<span class="line"><span>│          │                  │                    │                   │</span></span>
<span class="line"><span>│          └────────┬─────────┴────────────────────┘                   │</span></span>
<span class="line"><span>│                   ↓                                                  │</span></span>
<span class="line"><span>│   ┌───────────────────────────────────────────────────────┐         │</span></span>
<span class="line"><span>│   │              pending_requests_ queue                   │         │</span></span>
<span class="line"><span>│   │   [PUSH] [PUSH] [ACK] [PUSH] [POP] [ACK] [PUSH]       │         │</span></span>
<span class="line"><span>│   └───────────────────────────────────────────────────────┘         │</span></span>
<span class="line"><span>│                   ↓ drain_pending_to_slots()                         │</span></span>
<span class="line"><span>│   ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐                   │</span></span>
<span class="line"><span>│   │ Slot 0  │ │ Slot 1  │ │ Slot 2  │ │ Slot N  │                   │</span></span>
<span class="line"><span>│   │  PGconn │ │  PGconn │ │  PGconn │ │  PGconn │                   │</span></span>
<span class="line"><span>│   │uv_poll_t│ │uv_poll_t│ │uv_poll_t│ │uv_poll_t│                   │</span></span>
<span class="line"><span>│   └─────────┘ └─────────┘ └─────────┘ └─────────┘                   │</span></span>
<span class="line"><span>└─────────────────────────────────────────────────────────────────────┘</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p><strong>How libqueen works:</strong></p><ol><li><strong>Timer fires every 5ms</strong> — Collects all pending operations from the queue</li><li><strong>Groups operations by type</strong> — PUSH, POP, ACK, etc.</li><li><strong>Sends a single query per type</strong> — Microbatching: 1000 HTTP requests → 1 Postgres call</li><li><strong>Monitors PG sockets with <code>uv_poll</code></strong> — Non-blocking read/write</li><li><strong>Invokes callbacks</strong> when Postgres responds — Delivers results to HTTP thread via <code>uWS::Loop::defer()</code></li></ol><p><strong>libuv primitives used:</strong></p><table tabindex="0"><thead><tr><th>Component</th><th>Purpose</th></tr></thead><tbody><tr><td><code>uv_poll</code></td><td>Monitor PostgreSQL connection sockets for read/write events</td></tr><tr><td><code>uv_timer</code> (batch)</td><td>Accumulate requests for 5ms before sending (microbatching)</td></tr><tr><td><code>uv_timer</code> (waiting)</td><td>Long-polling for POP_WAIT with exponential backoff</td></tr><tr><td><code>uv_async</code></td><td>Wake libqueen immediately for latency-sensitive ops (POP, ACK)</td></tr></tbody></table><h3 id="_4-why-1-libqueen-per-1-uws-worker" tabindex="-1">4. Why 1 libqueen per 1 uWS Worker? <a class="header-anchor" href="#_4-why-1-libqueen-per-1-uws-worker" aria-label="Permalink to &quot;4. Why 1 libqueen per 1 uWS Worker?&quot;">​</a></h3><p>The alternative would be a single shared libqueen instance for all workers. But this would create:</p><ul><li><strong>Lock contention</strong> on the shared queue</li><li><strong>Single libuv loop</strong> becoming the bottleneck</li><li><strong>More complexity</strong> in callback management</li></ul><p>With the 1:1 approach, each worker is <strong>completely independent</strong>. If you have 12 workers, you have 12 libuv loops running in parallel, each with its own pool of Postgres connections. <strong>Workers never talk to each other.</strong></p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 12 workers = 12 libqueen instances = 12 × 50 = 600 Postgres connections</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> NUM_WORKERS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">12</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SIDECAR_POOL_SIZE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">50</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="_5-operation-specific-behavior" tabindex="-1">5. Operation-Specific Behavior <a class="header-anchor" href="#_5-operation-specific-behavior" aria-label="Permalink to &quot;5. Operation-Specific Behavior&quot;">​</a></h3><p>libqueen treats different operations differently for optimal performance:</p><table tabindex="0"><thead><tr><th>Operation</th><th>Signal Sent?</th><th>Why</th></tr></thead><tbody><tr><td><strong>PUSH</strong></td><td>❌ No (buffer only)</td><td>Allows requests to accumulate for maximum batching</td></tr><tr><td><strong>POP</strong></td><td>✅ Yes (immediate wake)</td><td>Latency-sensitive, needs fast response</td></tr><tr><td><strong>ACK</strong></td><td>✅ Yes (immediate wake)</td><td>Consumers waiting for acknowledgment</td></tr><tr><td><strong>POP_WAIT</strong></td><td>Goes to waiting queue</td><td>Separate timer-based polling with backoff</td></tr></tbody></table><p><strong>PUSH Optimization:</strong> When a PUSH request arrives, it&#39;s added to the pending queue but does <em>not</em> wake up libqueen immediately. This allows multiple PUSH requests to accumulate and be batched together when the 5ms timer fires.</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SIDECAR_POOL_SIZE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">50</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">              # Total connections (split among workers)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SIDECAR_MICRO_BATCH_WAIT_MS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     # Batching window</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SIDECAR_MAX_ITEMS_PER_TX</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1000</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     # Max items per transaction</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="request-flow-push" tabindex="-1">Request Flow: PUSH <a class="header-anchor" href="#request-flow-push" aria-label="Permalink to &quot;Request Flow: PUSH&quot;">​</a></h2><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>1. Client sends HTTP POST to /api/v1/push</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>2. Acceptor routes to Worker (round-robin)</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>3. Worker parses JSON, registers in ResponseRegistry</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>4. Worker queues request to libqueen</span></span>
<span class="line"><span>   (PUSH does NOT call uv_async_send - relies on batch timer)</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>5. libqueen batch timer fires (every 5ms)</span></span>
<span class="line"><span>   Collects all pending PUSH requests</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>6. libqueen calls: SELECT queen.push_messages_v2($1)</span></span>
<span class="line"><span>   PQsendQueryParams() (non-blocking)</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>7. uv_poll monitors socket for response</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>8. Result ready → parse JSONB → deliver to worker</span></span>
<span class="line"><span>   uWS::Loop::defer() (thread-safe)</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>9. Worker sends HTTP 201 response</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Total time: 10-50ms (typical)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h2 id="request-flow-pop" tabindex="-1">Request Flow: POP <a class="header-anchor" href="#request-flow-pop" aria-label="Permalink to &quot;Request Flow: POP&quot;">​</a></h2><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>1. Client sends GET to /api/v1/pop?partition=orders-123</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>2. Worker registers in ResponseRegistry</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>3. Worker queues to libqueen + uv_async_send() (immediate wake)</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>4. libqueen batches POP requests</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>5. Single call: SELECT queen.pop_unified_batch($1::jsonb)</span></span>
<span class="line"><span>   PostgreSQL handles atomically:</span></span>
<span class="line"><span>     - Acquire leases (SKIP LOCKED for wildcards)</span></span>
<span class="line"><span>     - Fetch messages after cursor</span></span>
<span class="line"><span>     - Release lease if empty</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>6. Messages returned as JSON</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>7. Response delivered to HTTP thread via defer()</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Total time: 3-10ms (typical)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h2 id="secondary-operations-asyncqueuemanager" tabindex="-1">Secondary Operations: AsyncQueueManager <a class="header-anchor" href="#secondary-operations-asyncqueuemanager" aria-label="Permalink to &quot;Secondary Operations: AsyncQueueManager&quot;">​</a></h2><p>While libqueen handles high-performance primary operations (PUSH, POP, ACK), the <strong>AsyncQueueManager</strong> handles secondary operations via a traditional connection pool:</p><table tabindex="0"><thead><tr><th>Operation</th><th>Path</th></tr></thead><tbody><tr><td><strong>Schema initialization</strong></td><td>AsyncQueueManager</td></tr><tr><td><strong>Queue configuration</strong></td><td>AsyncQueueManager</td></tr><tr><td><strong>Consumer group management</strong></td><td>AsyncQueueManager</td></tr><tr><td><strong>Message tracing</strong></td><td>AsyncQueueManager</td></tr><tr><td><strong>Maintenance mode</strong></td><td>AsyncQueueManager</td></tr><tr><td><strong>File buffer replay</strong></td><td>AsyncQueueManager</td></tr></tbody></table><p>This separation keeps the hot path (libqueen) lean and focused.</p><h2 id="background-services" tabindex="-1">Background Services <a class="header-anchor" href="#background-services" aria-label="Permalink to &quot;Background Services&quot;">​</a></h2><p>Queen runs three background services:</p><table tabindex="0"><thead><tr><th>Service</th><th>Purpose</th><th>Default Interval</th></tr></thead><tbody><tr><td><strong>MetricsCollector</strong></td><td>CPU, memory, queue depths</td><td>1s sample, 60s aggregate</td></tr><tr><td><strong>RetentionService</strong></td><td>Delete expired messages, empty partitions</td><td>5 minutes</td></tr><tr><td><strong>EvictionService</strong></td><td>Evict messages exceeding max_wait_time</td><td>1 minute</td></tr></tbody></table><h2 id="inter-instance-communication-udp" tabindex="-1">Inter-Instance Communication (UDP) <a class="header-anchor" href="#inter-instance-communication-udp" aria-label="Permalink to &quot;Inter-Instance Communication (UDP)&quot;">​</a></h2><p>In clustered deployments, servers notify each other via UDP when messages are pushed or acknowledged:</p><table tabindex="0"><thead><tr><th>Event</th><th>Notification</th><th>Effect</th></tr></thead><tbody><tr><td>PUSH (message queued)</td><td><code>MESSAGE_AVAILABLE</code></td><td>Wake waiting consumers</td></tr><tr><td>ACK (partition freed)</td><td><code>PARTITION_FREE</code></td><td>Wake consumers for partition</td></tr></tbody></table><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> QUEEN_UDP_PEERS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;queen-b:6633,queen-c:6633&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> QUEEN_UDP_NOTIFY_PORT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">6633</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="failover-layer-file-buffer" tabindex="-1">Failover Layer (File Buffer) <a class="header-anchor" href="#failover-layer-file-buffer" aria-label="Permalink to &quot;Failover Layer (File Buffer)&quot;">​</a></h2><p><strong>Zero message loss</strong> when PostgreSQL is unavailable:</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Normal:     PUSH → libqueen → PostgreSQL → Success</span></span>
<span class="line"><span>DB Down:    PUSH → Detect failure → Write to file buffer → Success</span></span>
<span class="line"><span>Recovery:   Background → Read .buf files → Replay to PostgreSQL</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_BUFFER_DIR</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/var/lib/queen/buffers</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_BUFFER_FLUSH_MS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">100</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_BUFFER_MAX_BATCH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">100</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="performance" tabindex="-1">Performance <a class="header-anchor" href="#performance" aria-label="Permalink to &quot;Performance&quot;">​</a></h2><table tabindex="0"><thead><tr><th>Metric</th><th>Value</th></tr></thead><tbody><tr><td>PUSH sustained</td><td>130K+ msg/s (batched)</td></tr><tr><td>POP sustained</td><td>50K+ ops/s</td></tr><tr><td>Single message</td><td>10K+ msg/s (no client batching)</td></tr><tr><td>PUSH latency</td><td>5-15ms</td></tr><tr><td>POP latency</td><td>3-10ms</td></tr></tbody></table><h2 id="scalability" tabindex="-1">Scalability <a class="header-anchor" href="#scalability" aria-label="Permalink to &quot;Scalability&quot;">​</a></h2><h3 id="horizontal" tabindex="-1">Horizontal <a class="header-anchor" href="#horizontal" aria-label="Permalink to &quot;Horizontal&quot;">​</a></h3><p>Deploy multiple instances behind a load balancer. Each server is stateless — any server handles any request.</p><h3 id="vertical" tabindex="-1">Vertical <a class="header-anchor" href="#vertical" aria-label="Permalink to &quot;Vertical&quot;">​</a></h3><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> NUM_WORKERS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">           # More workers</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SIDECAR_POOL_SIZE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">100</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # More PG connections per worker</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="design-principles" tabindex="-1">Design Principles <a class="header-anchor" href="#design-principles" aria-label="Permalink to &quot;Design Principles&quot;">​</a></h2><ol><li><strong>Non-blocking I/O</strong> — All database operations use async libpq + libuv</li><li><strong>Event-driven</strong> — Worker threads never block on I/O</li><li><strong>1:1 worker isolation</strong> — Each worker has its own libqueen, no contention</li><li><strong>Microbatching</strong> — Amortize overhead across multiple requests</li><li><strong>Stored procedures</strong> — Complex logic in PostgreSQL (single round-trip)</li><li><strong>Fail-safe</strong> — Automatic failover to file buffer</li></ol><h2 id="configuration-summary" tabindex="-1">Configuration Summary <a class="header-anchor" href="#configuration-summary" aria-label="Permalink to &quot;Configuration Summary&quot;">​</a></h2><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Server</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PORT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">6632</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> NUM_WORKERS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># libqueen (primary operations)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SIDECAR_POOL_SIZE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">50</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SIDECAR_MICRO_BATCH_WAIT_MS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SIDECAR_MAX_ITEMS_PER_TX</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1000</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># AsyncQueueManager (secondary operations)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DB_POOL_SIZE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">50</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DB_STATEMENT_TIMEOUT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">30000</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Background services</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> METRICS_SAMPLE_INTERVAL_MS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1000</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RETENTION_INTERVAL</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">300000</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> EVICTION_INTERVAL</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">60000</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Inter-instance (clustered)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> QUEEN_UDP_PEERS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;queen-b:6633,queen-c:6633&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> QUEEN_UDP_NOTIFY_PORT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">6633</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Failover</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_BUFFER_DIR</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/var/lib/queen/buffers</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h2 id="see-also" tabindex="-1">See Also <a class="header-anchor" href="#see-also" aria-label="Permalink to &quot;See Also&quot;">​</a></h2><ul><li><a href="/queen/server/how-it-works.html">How It Works</a> - Deep dive into libuv, microbatching, and PostgreSQL stored procedures</li><li><a href="/queen/server/environment-variables.html">Environment Variables</a> - Complete configuration reference</li><li><a href="/queen/server/tuning.html">Performance Tuning</a> - Optimization guide</li><li><a href="/queen/server/deployment.html">Deployment</a> - Production deployment patterns</li></ul>`,61)])])}const u=n(p,[["render",l]]);export{b as __pageData,u as default};
