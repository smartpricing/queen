import{_ as i,a,b as n,c as e,d as t,e as l}from"./chunks/cg2.C4JXn7Oc.js";import{_ as p,c as h,o as r,ag as k}from"./chunks/framework.-kPtTt-D.js";const d="/queen/learn/queen_logo.png",o="/queen/learn/degradation.png",c="/queen/learn/index_bloat_2.png",E="/queen/learn/do.png",g="/queen/learn/cg-final.png",u="/queen/learn/cg-pop-only.png",y="/queen/learn/diskread.png",_=JSON.parse('{"title":"What I learned developing Queen","description":"","frontmatter":{},"headers":[],"relativePath":"learn.md","filePath":"learn.md"}'),F={name:"learn.md"};function b(m,s,C,B,v,f){return r(),h("div",null,[...s[0]||(s[0]=[k('<h1 id="what-i-learned-developing-queen" tabindex="-1">What I learned developing Queen <a class="header-anchor" href="#what-i-learned-developing-queen" aria-label="Permalink to &quot;What I learned developing Queen&quot;">​</a></h1><p><em>This document describes both the technical aspects of the development of Queen and the lessons learned, and some benchmarks I&#39;ve made to test the scalability and performance of the system.</em></p><img src="'+d+`" alt="Queen" style="max-height:200px;"><h2 id="preface" tabindex="-1">Preface <a class="header-anchor" href="#preface" aria-label="Permalink to &quot;Preface&quot;">​</a></h2><p>Queen was born from a simple idea to make queue management easier for Smartchat, which didn&#39;t play well with Kafka. When I started developing it, I didn&#39;t really know where I was going or what I was doing.<br> The first working version with all the core features was developed in a few days in early October, in Node.js. Once I had the basic version running, I realized something good could come out of it and decided to rewrite the server in C++, a language I hold dear and consider the best for this kind of &quot;system&quot; application.</p><p>I knew very well I was getting myself into a mess: <strong>it&#39;s hard to build a program that does mainly I/O in C++ as fast as Node.js — with Node, speed comes for free.</strong> Those who&#39;ve interviewed with me know I always ask &quot;why is Node fast at I/O&quot;, and even though I knew the answer in theory (libuv), developing Queen allowed me to actually apply it. After 8 years developing mainly in Node, my C++ skills had dropped to a very low level, but with the help of AI and making a thousand mistakes, I somehow managed to get to something good.</p><p>This document is an attempt to share what I learned developing Queen, so that if anyone else approaches something like this they can do it faster and with fewer mistakes, and to try to explain where Node&#39;s I/O speed comes from.</p><p>Structure:</p><ul><li><a href="#the-problem">The problem</a></li><li><a href="#sockets-and-file-descriptors">Sockets and file descriptors</a></li><li><a href="#libuv">libuv</a></li><li><a href="#queens-architecture">Queen&#39;s Architecture</a></li><li><a href="#microbatching">Microbatching</a></li><li><a href="#benchmarks">Benchmarks</a><ul><li><a href="#1-sustained-load-test">Sustained load test</a> — 2B+ messages over 3 days at 10k req/s</li><li><a href="#2-push-batch-test">Push batch test</a> — 31k msg/s with 1GB/s disk write</li><li><a href="#3-consumer-group-test">Consumer groups test</a> — 4B+ messages at 75k msg/s with pub-sub pattern</li><li><a href="#4-results-summary">Results summary</a></li></ul></li><li><a href="#conclusions">Conclusions</a></li></ul><h2 id="the-problem" tabindex="-1">The problem <a class="header-anchor" href="#the-problem" aria-label="Permalink to &quot;The problem&quot;">​</a></h2><p>Both the Node and C++ versions of Queen use uWebSockets as the HTTP server, an ultra-fast C++ library for handling HTTP and WebSocket connections: uWebSockets is the HTTP engine behind Bun.</p><p>When I chose to use it, in my ignorance I thought everything would be easy and fast, and indeed with Node.js it was. When I started building the C++ version, I realized pretty quickly there was a problem: uWebSockets works by spinning up an event loop that handles all HTTP and WebSocket connections, using mechanisms we&#39;ll see later, and this is very fast, but with one fundamental rule: <strong>the event loop must be free to run, it must not be blocked by I/O operations.</strong></p><p>This is hard, because every call to Postgres blocks the event loop, and if the event loop is blocked, it can&#39;t handle HTTP and WebSocket connections, turning a potentially fast system into an embarrassingly slow one.</p><p>To understand why, let&#39;s look at what happens when you use libpq (the PostgreSQL C library) the &quot;normal&quot; way:</p><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> handle_push_request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Request</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> req</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 1. You&#39;re in the event loop, handling an HTTP request</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 2. You call Postgres synchronously</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    PGresult</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PQexec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(conn, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;INSERT INTO messages ...&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    //                 ^^^^^^^^</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    //                 This call BLOCKS. The CPU just sits there</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    //                 waiting for the network round-trip to Postgres.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    //                 Meanwhile, the event loop is frozen.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    //                 No other HTTP requests can be processed.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    //                 If this takes 5ms, you&#39;ve just wasted 5ms</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    //                 where you could have handled hundreds of requests.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 3. Only now can you respond</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    send_response</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(req, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;OK&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><em>No &quot;await&quot; magic available in C</em></p><p>The problem is that <code>PQexec()</code> is synchronous: it sends the query to Postgres, then <strong>waits</strong> for the response before returning. During this wait, your thread is doing nothing useful — it&#39;s just blocked on network I/O. And since the event loop runs on a single thread, nothing else can happen.</p><p>With a fast local Postgres, maybe that&#39;s 1-2ms per query. If you have 1000 requests per second and each one blocks for 2ms, you can only handle 500 req/s on a single thread.</p><p>The first solution I adopted was the classic one: use a thread pool to handle Postgres operations, so the event loop can run freely. I needed Queen ready as soon as possible for Smartchat&#39;s queues, so even though I knew it wasn&#39;t the best solution, I went with it.</p><p>This is the &quot;old school&quot; approach that servers like Apache use: new connection, new thread. One thread per Postgres connection. I could have stopped there, for Smartchat&#39;s needs it was more than fine. This approach has the problem of not being very scalable and efficient, because it creates a lot of context switching.</p><p>After a fairly long series of problems, experiments, errors, and various moments of despair, I eventually developed the fully asynchronous version of Queen, which, lo and behold, uses libuv itself to handle Postgres operations, using PG async API.</p><h2 id="sockets-and-file-descriptors" tabindex="-1">Sockets and file descriptors <a class="header-anchor" href="#sockets-and-file-descriptors" aria-label="Permalink to &quot;Sockets and file descriptors&quot;">​</a></h2><p>Before showing the final solution, we need to review some basic I/O programming concepts. In Unix/Linux, every network connection is represented by a file descriptor. A file descriptor is just an integer that represents a network connection.</p><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// IPv4 socket stream (aka TCP)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fd </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> socket</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(AF_INET, SOCK_STREAM, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // returns 5</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>What can we do with a file descriptor? Read and write to it. And how do we do that? With system calls.</p><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ssize_t</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> write</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> fd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">buf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">size_t</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> count</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ssize_t</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> read</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> fd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">buf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">size_t</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> count</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>If there&#39;s no data to read, read blocks. If there&#39;s no space to write, write blocks. You can see that if you need to read/write from multiple sockets, this approach doesn&#39;t work well. So we can use the <em>select</em> call to monitor multiple file descriptors at once.</p><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> nfds</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, fd_set </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">readfds</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, fd_set </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">writefds</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, fd_set </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">exceptfds</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> timeval </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">timeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><em>select</em> takes an array of file descriptors and a timeout as input. It returns the number of file descriptors that are ready to read or write.</p><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 1. Ask which fds are ready (doesn&#39;t block, or blocks with timeout)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(max_fd </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">read_fds, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 2. Read ONLY from those that are ready (will never block)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fd </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; fd </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> max_fd; fd</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FD_ISSET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fd, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">read_fds)) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            read</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fd, buffer, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1024</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // There&#39;s definitely data to read</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>This approach is very good, but it has a problem: it scales with O(n) file descriptors. If we have 1000 file descriptors to monitor, we have to call select every time passing all 1000 file descriptors and the kernel has to loop through them, and then we have to loop through all the file descriptors again and read/write only those that are ready.</p><p>To solve this problem, more sophisticated mechanisms are used like <em>epoll</em> (for Linux) and <em>kqueue</em> (for BSD/macOS). These mechanisms are much more efficient because they don&#39;t have the O(n) scaling problem.</p><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Register once</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">epoll_ctl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(epoll_fd, EPOLL_CTL_ADD, fd, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ev</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Then just ask &quot;who&#39;s ready?&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> n </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> epoll_wait</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(epoll_fd, events, MAX, timeout);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// → returns ONLY the 2 ready fds, not all 1000</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>So by using mechanisms like epoll and kqueue, we can send our queries to Postgres asynchronously, and then check only the file descriptors that are ready to read or write.</p><h2 id="libuv" tabindex="-1">libuv <a class="header-anchor" href="#libuv" aria-label="Permalink to &quot;libuv&quot;">​</a></h2><p>What does this blessed library used by Node.js, uvloop in Python, and a thousand other libraries/software (also the first versions of Rust used libuv under the hood, before Tokio and other async crates) actually do? Mainly two things:</p><ol><li>Handle I/O operations asynchronously with the same interface on the three main operating systems</li><li>Expose a set of async primitives to handle I/O operations asynchronously</li></ol><p>In practice libuv uses epoll, kqueue under the hood.</p><p>The main async primitives are:</p><ul><li>uv_poll: monitor file descriptors for reading or writing</li><li>uv_timer: timers to execute operations periodically</li><li>uv_async: signal to execute operations asynchronously</li><li>uv_fs: file system operations</li><li>uv_work: thread operations</li></ul><p>It also provides a threadpool to execute those operations that can&#39;t be done asynchronously by the operating system, like DNS resolution, compression, filesystem reads, etc.</p><h3 id="how-node-js-maps-to-libuv" tabindex="-1">How Node.js maps to libuv <a class="header-anchor" href="#how-node-js-maps-to-libuv" aria-label="Permalink to &quot;How Node.js maps to libuv&quot;">​</a></h3><p>If you&#39;ve ever wondered what happens when you call <code>setTimeout()</code> in Node.js, here&#39;s the answer:</p><table tabindex="0"><thead><tr><th>Node.js API</th><th>libuv call</th><th>Notes</th></tr></thead><tbody><tr><td><code>setTimeout(fn, ms)</code></td><td><code>uv_timer_start()</code></td><td>Single-shot timer</td></tr><tr><td><code>setInterval(fn, ms)</code></td><td><code>uv_timer_start()</code></td><td>With repeat flag</td></tr><tr><td><code>setImmediate(fn)</code></td><td><code>uv_check_t</code></td><td>Runs after I/O poll phase</td></tr><tr><td><code>fs.readFile()</code></td><td><code>uv_fs_read()</code></td><td>Uses threadpool</td></tr><tr><td><code>net.createServer()</code></td><td><code>uv_tcp_init()</code> + <code>uv_listen()</code></td><td>Event-based</td></tr><tr><td><code>dns.lookup()</code></td><td><code>uv_getaddrinfo()</code></td><td>Uses threadpool</td></tr></tbody></table><p>So when you write:</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setTimeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Hello!&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>Node.js is essentially doing:</p><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">uv_timer_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> timer;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">uv_timer_init</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(loop, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">timer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">uv_timer_start</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">timer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, on_timeout_callback, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//                                          ^^^^  ^^^</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//                                          delay  repeat (0 = no repeat)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>Here&#39;s an example of how to use libuv to handle I/O operations asynchronously:</p><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;uv.h&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;libpq-fe.h&gt;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // PostgreSQL C library</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">uv_poll_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pg_poll;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PGconn</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> conn;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Callback called when the Postgres socket is ready</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> on_postgres_ready</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">uv_poll_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> status</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> events</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Socket is ready → read the result (does NOT block!)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    PQconsumeInput</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(conn);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PQisBusy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(conn) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // Query complete!</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        PGresult</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PQgetResult</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(conn);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Got </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rows!</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PQntuples</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(result));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        PQclear</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(result);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    uv_loop_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> loop;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    uv_loop_init</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">loop);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 1. Connect to Postgres in NON-BLOCKING mode</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    conn </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PQconnectdb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;host=localhost dbname=queen&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    PQsetnonblocking</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(conn, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 2. Get the file descriptor of the Postgres socket</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pg_socket </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PQsocket</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(conn);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // ← it&#39;s just a number!</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 3. Register the socket with libuv (like epoll_ctl)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    uv_poll_init</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">loop, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">pg_poll, pg_socket);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    uv_poll_start</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">pg_poll, UV_READABLE, on_postgres_ready);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 4. Send a query in async mode (does NOT wait for response)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    PQsendQuery</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(conn, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;SELECT * FROM messages&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 5. Start the loop - it will wake us when Postgres responds</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    uv_run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">loop, UV_RUN_DEFAULT);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>This is how Queen talks to Postgres. We register it with libuv, and when the response arrives, libuv wakes us up and we call <code>PQconsumeInput()</code> — which never blocks because we already know the data is ready.</p><h2 id="queen-s-architecture" tabindex="-1">Queen&#39;s Architecture <a class="header-anchor" href="#queen-s-architecture" aria-label="Permalink to &quot;Queen&#39;s Architecture&quot;">​</a></h2><p>With these concepts clear, we can look at Queen&#39;s final architecture. The system uses the <strong>acceptor/worker pattern</strong> to scale across multiple cores:</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>                         ┌─────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>                         │                         QUEEN SERVER                        │</span></span>
<span class="line"><span>                         └─────────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                                                      │</span></span>
<span class="line"><span>                                                      ▼</span></span>
<span class="line"><span>                         ┌─────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>                         │              ACCEPTOR (port 6632, round-robin)              │</span></span>
<span class="line"><span>                         │                    uWebSockets event loop                   │</span></span>
<span class="line"><span>                         └────────────┬───────────────┬───────────────┬────────────────┘</span></span>
<span class="line"><span>                                      │               │               │</span></span>
<span class="line"><span>              ┌───────────────────────┼───────────────┼───────────────┼────────────────────────┐</span></span>
<span class="line"><span>              │                       │               │               │                        │</span></span>
<span class="line"><span>              ▼                       ▼               ▼               ▼                        ▼</span></span>
<span class="line"><span>┌─────────────────────┐ ┌─────────────────────┐           ┌─────────────────────┐ ┌─────────────────────┐</span></span>
<span class="line"><span>│    UWS WORKER 0     │ │    UWS WORKER 1     │    ...    │   UWS WORKER N-1    │ │    UWS WORKER N     │</span></span>
<span class="line"><span>│   (event loop)      │ │   (event loop)      │           │   (event loop)      │ │   (event loop)      │</span></span>
<span class="line"><span>│                     │ │                     │           │                     │ │                     │</span></span>
<span class="line"><span>│  ┌───────────────┐  │ │  ┌───────────────┐  │           │  ┌───────────────┐  │ │  ┌───────────────┐  │</span></span>
<span class="line"><span>│  │ HTTP Handler  │  │ │  │ HTTP Handler  │  │           │  │ HTTP Handler  │  │ │  │ HTTP Handler  │  │</span></span>
<span class="line"><span>│  └───────┬───────┘  │ │  └───────┬───────┘  │           │  └───────┬───────┘  │ │  └───────┬───────┘  │</span></span>
<span class="line"><span>│          │          │ │          │          │           │          │          │ │          │          │</span></span>
<span class="line"><span>│          ▼          │ │          ▼          │           │          ▼          │ │          ▼          │</span></span>
<span class="line"><span>│  ┌───────────────┐  │ │  ┌───────────────┐  │           │  ┌───────────────┐  │ │  ┌───────────────┐  │</span></span>
<span class="line"><span>│  │  Mutex Queue  │  │ │  │  Mutex Queue  │  │           │  │  Mutex Queue  │  │ │  │  Mutex Queue  │  │</span></span>
<span class="line"><span>│  └───────┬───────┘  │ │  └───────┬───────┘  │           │  └───────┬───────┘  │ │  └───────┬───────┘  │</span></span>
<span class="line"><span>│          │          │ │          │          │           │          │          │ │          │          │</span></span>
<span class="line"><span>│          ▼          │ │          ▼          │           │          ▼          │ │          ▼          │</span></span>
<span class="line"><span>│  ┌───────────────┐  │ │  ┌───────────────┐  │           │  ┌───────────────┐  │ │  ┌───────────────┐  │</span></span>
<span class="line"><span>│  │ LIBQUEEN 0    │  │ │  │ LIBQUEEN 1    │  │           │  │ LIBQUEEN N-1  │  │ │  │ LIBQUEEN N    │  │</span></span>
<span class="line"><span>│  │ (libuv loop)  │  │ │  │ (libuv loop)  │  │           │  │ (libuv loop)  │  │ │  │ (libuv loop)  │  │</span></span>
<span class="line"><span>│  │               │  │ │  │               │  │           │  │               │  │ │  │               │  │</span></span>
<span class="line"><span>│  │ Timer (5ms)   │  │ │  │ Timer (5ms)   │  │           │  │ Timer (5ms)   │  │ │  │ Timer (5ms)   │  │</span></span>
<span class="line"><span>│  │      │        │  │ │  │      │        │  │           │  │      │        │  │ │  │      │        │  │</span></span>
<span class="line"><span>│  │      ▼        │  │ │  │      ▼        │  │           │  │      ▼        │  │ │  │      ▼        │  │</span></span>
<span class="line"><span>│  │ Microbatch    │  │ │  │ Microbatch    │  │           │  │ Microbatch    │  │ │  │ Microbatch    │  │</span></span>
<span class="line"><span>│  │      │        │  │ │  │      │        │  │           │  │      │        │  │ │  │      │        │  │</span></span>
<span class="line"><span>│  │      ▼        │  │ │  │      ▼        │  │           │  │      ▼        │  │ │  │      ▼        │  │</span></span>
<span class="line"><span>│  │ PG Pool (M)   │  │ │  │ PG Pool (M)   │  │           │  │ PG Pool (M)   │  │ │  │ PG Pool (M)   │  │</span></span>
<span class="line"><span>│  └───────────────┘  │ │  └───────────────┘  │           │  └───────────────┘  │ │  └───────────────┘  │</span></span>
<span class="line"><span>└─────────────────────┘ └─────────────────────┘           └─────────────────────┘ └─────────────────────┘</span></span>
<span class="line"><span>              │                       │               │               │                        │</span></span>
<span class="line"><span>              └───────────────────────┴───────────────┴───────────────┴────────────────────────┘</span></span>
<span class="line"><span>                                                      │</span></span>
<span class="line"><span>                                                      ▼</span></span>
<span class="line"><span>                                         ┌─────────────────────────┐</span></span>
<span class="line"><span>                                         │       PostgreSQL        │</span></span>
<span class="line"><span>                                         │    (N×M connections)    │</span></span>
<span class="line"><span>                                         └─────────────────────────┘</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>There are also some other services like Retention and Eviction, that are not shown in the diagram above, usually run in a separate thread started from the worker 0.</p><h3 id="how-it-works" tabindex="-1">How it works <a class="header-anchor" href="#how-it-works" aria-label="Permalink to &quot;How it works&quot;">​</a></h3><ol><li><p><strong>Acceptor</strong>: A single thread that listens on port 6632 and distributes connections to workers in round-robin fashion. It does nothing but pass sockets along.</p></li><li><p><strong>UWS Workers</strong>: Each worker is a thread with its own uWebSockets event loop. When an HTTP request arrives (e.g. push), the worker:</p><ul><li>Parses the request</li><li>Pushes the operation onto a mutex-protected queue</li><li><strong>Does not wait</strong> — the HTTP response will be sent when Postgres responds</li></ul></li><li><p><strong>libqueen</strong>: Each worker has its own libqueen instance, which runs in a separate thread with its own libuv event loop. libqueen:</p><ul><li>Has a timer that fires every 5ms</li><li>Drains the operations queue</li><li>Groups operations by type (PUSH, POP, ACK, etc.)</li><li>Sends <strong>a single query</strong> to Postgres for each type</li><li>When Postgres responds, invokes the callbacks for each request</li></ul></li><li><p><strong>No lock contention between workers</strong>: Each worker has its own queue, its own libqueen instance, and its own connection pool. Workers never talk to each other.</p></li></ol><h3 id="why-1-libqueen-per-1-uws-worker" tabindex="-1">Why 1 libqueen per 1 uWS worker? <a class="header-anchor" href="#why-1-libqueen-per-1-uws-worker" aria-label="Permalink to &quot;Why 1 libqueen per 1 uWS worker?&quot;">​</a></h3><p>The alternative would be to have a single libqueen instance shared among all workers. But this would create:</p><ul><li>Lock contention on the shared queue</li><li>A single libuv loop becoming the bottleneck</li><li>More complexity in callback management</li></ul><p>With the 1:1 approach, each worker is completely independent. If you have 12 workers, you have 12 libuv loops running in parallel, each with its own pool of Postgres connections.</p><h2 id="microbatching" tabindex="-1">Microbatching <a class="header-anchor" href="#microbatching" aria-label="Permalink to &quot;Microbatching&quot;">​</a></h2><p>In practice, Queen doesn&#39;t use <em>uv_async_send</em> to wake up the loop, but uses <em>uv_timer_start</em> to execute an operation periodically. In short, every time one of the uWebSockets workers receives a request, it pushes the operation to be performed onto a mutex-protected queue. The libuv timer is set to fire every 5 ms, so every time it&#39;s called, the loop finds a series of operations to execute. These operations can be of type:</p><ul><li>PUSH</li><li>POP</li><li>ACK</li><li>TRANSACTION</li><li>RENEW_LEASE</li><li>CUSTOM</li></ul><p>The code then groups operations by type, and sends a single query to Postgres for each type of operation, batching the operations and reducing the number of round trips with the database. For this to work, obviously the queries need to be designed to work in batch. This technique slightly increases the latency of a single operation, but increases throughput significantly. For example, during the benchmark described below, each Queen worker executed on average 1000 batched operations per second, which means that from 1000 requests per second arriving on that worker via HTTP, a single call to Postgres was made.</p><p>During the final phase of development, all the queries that were previously scattered throughout the application code were transformed into Postgres stored procedures, which also makes it possible to &quot;use Queen&quot; directly from psql.</p><h2 id="benchmarks" tabindex="-1">Benchmarks <a class="header-anchor" href="#benchmarks" aria-label="Permalink to &quot;Benchmarks&quot;">​</a></h2><h3 id="_1-sustained-load-test" tabindex="-1">1. Sustained load test <a class="header-anchor" href="#_1-sustained-load-test" aria-label="Permalink to &quot;1. Sustained load test&quot;">​</a></h3><p>Queen wasn&#39;t designed to break records or to be blazing fast, but rather to be simple, maintainable, and to easily handle slow processes: this led to the choice of using HTTP and &quot;dumb&quot; stateless clients and servers, without any special coordination between the server and the clients.</p><p>But from the beginning I wanted to see how fast it could go. The versions before libuv were very slow, and the only way to make them fast was to do client-side batching, to reduce the number of round trips with the server and database, i.e. pushing and popping multiple messages in a single round trip (which is absolutely normal and done by all queue systems). With the C++ version with libuv and microbatching, Queen turned out to be pretty fast, showing push peaks of 45k req/s. But dealing with Postgres and all the vacuum mechanisms and tables growing, the question that came to mind was: how much sustained load can it handle? <strong>So I set myself the challenge: push 10000 messages per second (in single requests of 1 message each) and consume them for a week straight.</strong></p><p>Queen has three main operations: PUSH, POP and ACK. PUSH and POP are the most important, and are the ones that are most often used. ACK is used to acknowledge that a message has been processed. So the flow is:</p><ol><li>Client sends a PUSH request to the server</li><li>Server pushes the message to the database</li><li>Another client sends a POP request to the server</li><li>Server pops the message from the database</li><li>The client receives the message, processes it and sends an ACK request to the server</li><li>Server acknowledges the message</li></ol><p>For the benchmark, I used a special POP request that ACKs the message automatically, moving down the quality of service to &quot;at most once&quot;. This is due to the fact that the Queen clients are not designed to be benchmark tools, so I needed to use some other tool to create a decent load. Those third-party tools usually do not allow implementing logic like &quot;do pop and then ack it&quot;. Since Queen uses HTTP, I had a plethora of tools to choose from, and I used <em>autocannon</em> with this configuration:</p><p>Producer:</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Per 10 workers like this, using cluster mode</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> instance</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> autocannon</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  url: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">SERVER_URL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  connections: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  duration: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;1 week&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  requests: [Array </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">of</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> requests]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">requests.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">push</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    method: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;POST&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    path: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;/api/v1/push&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    headers: {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &#39;Content-Type&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;application/json&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    body: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      items: [{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        queue: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">QUEUE_NAME</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        partition: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        payload: { </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          message: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Hello World&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          partition_id: i</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    })</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>Consumer:</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> instance</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> autocannon</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  url: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">SERVER_URL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  connections: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">50</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  duration: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;1 week&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  requests: [Array </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">of</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> requests],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  workers: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    requests.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">push</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      method: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;GET&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      path: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`/api/v1/pop/queue/\${</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">QUEUE_NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}?batch=\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">batchSize</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}&amp;wait=true&amp;autoAck=true\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Note autoAck=true to acknowledge the message automatically</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      headers: { </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Content-Type&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;application/json&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    });</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>Also note that for POP we do not specify the partition, simulating a real consumer that usually does not know the partition of the message, but rather the queue name. This requires the server to find available partitions for each POP request.</p><p>So the benchmark setup is like this:</p><ul><li>1 single machine with 32 cores and 64GB of RAM, 2TB disk</li><li>Postgres and Queen as docker containers, without cpuset</li><li>1 queue with 1000 partitions</li><li>10 producers with total 1000 connections</li><li>1 consumer with 50 connections, batch size of 50 (so the POP calls usually return more than one message, if present)</li></ul><p>The Queen and Postgres config were:</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> network</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> create</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> queen</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --ulimit</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nofile=65535:65535</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> postgres</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --network</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> queen</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> POSTGRES_PASSWORD=postgres</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 5432:5432</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> postgres</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> shared_buffers=4GB</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> max_connections=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">300</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> temp_buffers=128MB</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> work_mem=64MB</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> max_parallel_workers=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">18</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> max_worker_processes=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">18</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> checkpoint_timeout=30min</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> checkpoint_completion_target=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.9</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> max_wal_size=16GB</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> min_wal_size=4GB</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> wal_buffers=64MB</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> wal_compression=on</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> synchronous_commit=off</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> autovacuum_vacuum_cost_limit=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> autovacuum_vacuum_cost_delay=2ms</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> autovacuum_max_workers=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> maintenance_work_mem=2GB</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> effective_io_concurrency=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">200</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> random_page_cost=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1.1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> effective_cache_size=32GB</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> huge_pages=try</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --ulimit</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nofile=65535:65535</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> queen</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 6632:6632</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --network</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> queen</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> PG_HOST=postgres</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> PG_PASSWORD=postgres</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> NUM_WORKERS=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> DB_POOL_SIZE=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">50</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> SIDECAR_POOL_SIZE=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">250</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> SIDECAR_MICRO_BATCH_WAIT_MS=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> POP_WAIT_INITIAL_INTERVAL_MS=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> POP_WAIT_BACKOFF_THRESHOLD=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> POP_WAIT_BACKOFF_MULTIPLIER=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2.0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> POP_WAIT_MAX_INTERVAL_MS=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> DEFAULT_SUBSCRIPTION_MODE=new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> RETENTION_INTERVAL=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">300000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> RETENTION_BATCH_SIZE=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">500000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> LOG_LEVEL=info</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> DB_STATEMENT_TIMEOUT=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">300000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> STATS_RECONCILE_INTERVAL_MS=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8640000</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> smartnessai/queen-mq:0.11.0-dev-7</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><img src="`+o+'" alt="Degradation"><em>Degradation of performance after a few million messages</em></p><p>The first experiments were embarrassing. After a few million messages, performance degraded drastically. With the invaluable help of AI debugging, which knows Postgres way better than me, I discovered that most of the problem was due to these things:</p><h4 id="indexes-blocking-hot-updates" tabindex="-1">Indexes blocking HOT updates <a class="header-anchor" href="#indexes-blocking-hot-updates" aria-label="Permalink to &quot;Indexes blocking HOT updates&quot;">​</a></h4><p>PostgreSQL has a mechanism called <strong>HOT (Heap-Only Tuple) updates</strong>: when you update a row and the indexed columns DON&#39;T change, Postgres can do an &quot;update in place&quot; without creating dead tuples. But if even ONE indexed column changes, you have to create a new tuple and the old one becomes &quot;dead&quot;.</p><p><img src="'+c+`" alt="Index bloat visualization"></p><p><em>You can see the situation in the screenshot above, where the index is bloated with dead tuples at 6k req/s, then a full vacuum, and finally the index is removed</em></p><p>I had an index <code>(queue_name, last_message_created_at)</code> on a table that was updated on every push. Result: after 10 hours, a table with 1000 rows weighed <strong>94MB</strong> instead of ~100KB. 600x bloat!</p><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Before: 0.8% HOT updates (disaster)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- After dropping the useless index: 99.9% HOT updates</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> n_tup_hot_upd::</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">numeric</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> /</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> n_tup_upd </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> hot_pct</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pg_stat_user_tables </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> relname </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;partition_lookup&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>The lesson: <strong>every index has a cost</strong>. If a column is updated frequently, don&#39;t index it unless strictly necessary.</p><h4 id="not-in-vs-not-exists" tabindex="-1">NOT IN vs NOT EXISTS <a class="header-anchor" href="#not-in-vs-not-exists" aria-label="Permalink to &quot;NOT IN vs NOT EXISTS&quot;">​</a></h4><p>I had a query to find partitions without messages:</p><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- WRONG: scans the ENTIRE messages table to build the list</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> partition_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">NOT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> IN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    SELECT DISTINCT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> partition_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> queen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">messages</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- CORRECT: uses the index and stops at first match</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> NOT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> EXISTS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    SELECT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> queen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">messages</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> m </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    WHERE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> m</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">partition_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> p</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> LIMIT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>With millions of rows, the first version took 77 seconds and blocked everything. The second is instant.</p><h4 id="duplicate-indexes" tabindex="-1">Duplicate indexes <a class="header-anchor" href="#duplicate-indexes" aria-label="Permalink to &quot;Duplicate indexes&quot;">​</a></h4><p>I had accidentally created two identical indexes:</p><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">idx_messages_partition_created    </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (partition_id, created_at, id)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">idx_messages_partition_created_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (partition_id, created_at, id)  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- IDENTICAL!</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>3.1GB of wasted space, and every INSERT had to update both.</p><h4 id="checkpoints-too-frequent" tabindex="-1">Checkpoints too frequent <a class="header-anchor" href="#checkpoints-too-frequent" aria-label="Permalink to &quot;Checkpoints too frequent&quot;">​</a></h4><p>With the <code>max_wal_size=16GB</code> setting, Postgres was doing a checkpoint every ~5 minutes under load. Every checkpoint = flush of all dirty buffers = I/O spike = latency spike.</p><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 202 forced checkpoints, 0 scheduled = WAL too small</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> num_timed, num_requested </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pg_stat_checkpointer;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>It wasn&#39;t possible to increase the WAL size during the benchmark because it would have meant stopping it, but it&#39;s something to keep in mind for next time.</p><p>After these fixes, discoverable only through sustained effort, Queen and Postgres became steady as a clock, doing between 9500 and 10500 req/s every second.</p><p>Here are the useful queries we used to monitor the situation:</p><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pid, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> query_start </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> duration, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">state</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, query </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pg_stat_activity                                          </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> state</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;idle&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ORDER BY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> duration </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DESC</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Get dead tuples</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> schemaname, relname, n_dead_tup, n_live_tup, </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">       round</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(n_dead_tup::</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">numeric</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> /</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nullif</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(n_live_tup, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> dead_pct,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">       last_vacuum, last_autovacuum</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pg_stat_user_tables</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ORDER BY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> n_dead_tup </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DESC</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">LIMIT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Check for any slow queries</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pid, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> query_start </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> duration, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">left</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(query, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">80</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pg_stat_activity </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> state</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;active&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> AND</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> query_start </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> interval </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;1 second&#39;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ORDER BY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> duration </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DESC</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Check autovacuum isn&#39;t stuck</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> relname, last_autovacuum, n_dead_tup </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pg_stat_user_tables </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> n_dead_tup </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ORDER BY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> n_dead_tup </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DESC</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- HOT check</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    n_tup_upd,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    n_tup_hot_upd,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    round</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(n_tup_hot_upd::</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">numeric</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> /</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nullif</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(n_tup_upd, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> hot_update_pct</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pg_stat_user_tables </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> relname </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;partition_lookup&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>Obviously it&#39;s not possible to keep all messages on disk for such a long period (we&#39;re talking about several TB of data), so I set the cleanup service very aggressively, so there were never more than half an hour of messages on disk (about 30 million). The performance figures above include the cleanup service that removes old messages. Here is the example logs of the cleanup service:</p><div class="language-log vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">log</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">2025-12-17</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> 07:22:46.198</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">[info]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RetentionService: Cleaned up expired_messages=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">88970</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, completed_messages=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">93680</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, inactive_partitions=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, old_metrics=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">2025-12-17</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> 07:23:20.095</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">[info]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RetentionService: Cleaned up expired_messages=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">97540</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, completed_messages=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">110750</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, inactive_partitions=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, old_metrics=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">2025-12-17</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> 07:23:59.718</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">[info]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RetentionService: Cleaned up expired_messages=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">109100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, completed_messages=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">128650</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, inactive_partitions=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, old_metrics=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">2025-12-17</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> 07:24:46.610</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">[info]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RetentionService: Cleaned up expired_messages=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">136040</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, completed_messages=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">145270</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, inactive_partitions=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, old_metrics=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">2025-12-17</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> 07:26:06.971</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">[info]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RetentionService: Cleaned up expired_messages=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">307470</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, completed_messages=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">195230</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, inactive_partitions=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, old_metrics=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">2025-12-17</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> 07:27:10.231</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">[info]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RetentionService: Cleaned up expired_messages=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">203410</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, completed_messages=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">190060</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, inactive_partitions=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, old_metrics=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">2025-12-17</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> 07:27:33.542</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">[info]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RetentionService: Cleaned up expired_messages=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">227700</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, completed_messages=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">125920</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, inactive_partitions=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, old_metrics=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">...</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>After almost three days of pushing and consuming with a steady load, I interrupted the benchmark: it was clear that there wouldn&#39;t be any issues in the following days, so I stopped, deployed a new version of Queen (with better charts) and resumed the benchmark.</p><p><strong>In the end the challenge was won: Queen is able to push and consume around 10000 messages per second for days straight, using only 80 GB of disk space.</strong></p><p><img src="`+i+'" alt="1 Billion"></p><p><em>The first billion (1.322B) messages</em></p><p><img src="'+E+`" alt="2Gb/s"><em>Writing 2Gb/s of &quot;hello world&quot; inside Postgres for days (of course this includes a lot more than just &quot;hello world&quot;)</em></p><p>After 2.5 days the situation was like this:</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">CONTAINER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ID</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">       CPU</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> %</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      MEM</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> USAGE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> LIMIT</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     MEM</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> %</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     NET</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> I/O</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">           BLOCK</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> I/O</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">         PIDS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">a78d0500a542</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   queen</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      324.78%</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    146.5MiB</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 62.79GiB</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   0.23%</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     2.55TB</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 6.64TB</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   14.3MB</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 0B</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">       51</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">673130dd43d8</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   postgres</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   1001.05%</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   46.82GiB</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 62.79GiB</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   74.57%</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    456GB</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 982GB</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     30.1GB</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 43.3TB</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   307</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>We have produced, consumed and also deleted more than 2 billion messages, at an average rate of 9500 req/s. In this time, Queen used 133 MB of RAM steadily.</p><p><img src="`+a+`" alt="Final"></p><h3 id="_2-push-batch-test" tabindex="-1">2. Push batch test <a class="header-anchor" href="#_2-push-batch-test" aria-label="Permalink to &quot;2. Push batch test&quot;">​</a></h3><p>Due to the fact that Queen was able to sustain the load for days, I&#39;ve also made some other smaller benchmarks to test the scalability of the system and the performance of the different features.</p><p>Avg throughput: 31170 msg/s push and pop, disk writing at almost 1GB/s (10 Gb/s), &gt; 2M messages per minute. I&#39;m not sure but maybe here we are very close to the limit of WAL write speed.</p><p>To make this throughput sustainable, I needed to tweak the Postgres settings:</p><div class="language-ini vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ini</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">shared_buffers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=1GB </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">temp_buffers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=64MB</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">work_mem</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=64MB</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">max_wal_size</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=4GB</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">min_wal_size</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=1GB</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>And also tweak the autovacuum settings:</p><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ALTER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> queen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">messages</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> SET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    autovacuum_vacuum_scale_factor </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">001</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    autovacuum_vacuum_threshold </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    autovacuum_vacuum_cost_delay </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    autovacuum_vacuum_cost_limit </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    toast</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">autovacuum_vacuum_cost_delay</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ALTER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> queen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">messages</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> SET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    autovacuum_vacuum_insert_scale_factor </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">001</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><img src="`+n+'" alt="Push batch and Pop"></p><p><img src="'+e+'" alt="Push batch and Pop"></p><h3 id="_3-consumer-group-test" tabindex="-1">3. Consumer group test <a class="header-anchor" href="#_3-consumer-group-test" aria-label="Permalink to &quot;3. Consumer group test&quot;">​</a></h3><p>In this test we have a producer that produces on a queue with 1000 partitions, with 100 connections and batch size 10, and 11 consumer groups (eleven because I used &lt;= in the for loop) on 5 workers with 50 connections each. This test aims to test the scalability of the consumer group feature, a pub-sub pattern, where each consumer group receives all the messages from the queue.</p><p><img src="'+t+'" alt="Consumer group consumption"><em>At the peak, Queen was using 10 cores, with a huge event loop lag, with 250k msg/s pop throughput</em></p><p>At the beginning, probably due to the fact that the benchmark did not warm up and started nuking Queen, the consumer pop rate was zero, accumulating messages in the queue. Then after some minutes, the consumer group started to pop messages at an initial rate of 250k msg/s, then stabilized at 6.8k push and (6.8k push × 11 consumers) 75k msg/s pop rate, using almost three cores and 1GB of RAM.</p><p><img src="'+l+`" alt="Consumer group consumption"><em>I was surprised about the pop performance in the consumer group mode. Queen is primarily designed to be a queue system, but it seems to be able to handle the pub-sub pattern with ease.</em></p><p>Final resource usage:</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">CONTAINER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ID</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">       CPU</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> %</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      MEM</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> USAGE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> LIMIT</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     MEM</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> %</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     NET</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> I/O</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">           BLOCK</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> I/O</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">         PIDS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">903ff045b42e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   queen</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      357.59%</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    1.001GiB</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 62.79GiB</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   1.59%</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     1.25TB</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 1.72TB</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   606kB</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 0B</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        43</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">f8e4164e0d92</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   postgres</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   1966.34%</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   32.29GiB</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 62.79GiB</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   51.43%</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    113GB</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 1.13TB</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    1.28MB</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 13.4TB</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   957</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>You can see that the NET Output of Postgres is 1.13TB, that is roughly ten times the input.</p><p><img src="`+g+'" alt="Final resource usage"><em>After almost 16 hours I stopped the benchmark: we have produced 420M messages, and we have consumed them all from 11 consumer groups, for a total of 4.5B messages, at an average pop rate of 75k msgs/s</em></p><p>If we only pop with the same configuration, without pushing, we sustain 350k msg/s pop rate, using almost 14 cores and 5GB of RAM:</p><p><img src="'+u+`" alt="POP Only"></p><h3 id="_4-results-summary" tabindex="-1">4. Results summary <a class="header-anchor" href="#_4-results-summary" aria-label="Permalink to &quot;4. Results summary&quot;">​</a></h3><table tabindex="0"><thead><tr><th>Test</th><th>Producer Config</th><th>Consumer Config</th><th>Throughput</th><th>Resources</th></tr></thead><tbody><tr><td><strong>Sustained load</strong></td><td>10 workers, 1000 connections, 1 msg/req</td><td>1 worker, 50 connections, batch 50, autoAck</td><td>~10k req/s (sustained for days)</td><td>Queen: 133 MB RAM, ~3 cores</td></tr><tr><td><strong>Push batch</strong></td><td>1 worker, 50 connections, 1000 msgs/request</td><td>5 workers, 50 connections each, autoAck</td><td>~31k msg/s</td><td>Disk: ~1 GB/s write</td></tr><tr><td><strong>Consumer groups</strong></td><td>1 producer, 100 connections, batch 10</td><td>11 consumer groups, 5 workers, 50 connections each, autoAck</td><td>6.8k push / 75k pop msg/s</td><td>Queen: 1 GB RAM, ~3 cores</td></tr></tbody></table><h4 id="considerations" tabindex="-1">Considerations <a class="header-anchor" href="#considerations" aria-label="Permalink to &quot;Considerations&quot;">​</a></h4><p>As long as we don&#39;t write too much and Postgres can keep messages in memory, the system is very fast and stable. But if the pushed data is large and Postgres needs to read it from disk, high contention and slowdowns are inevitable.</p><p><strong>PostgreSQL Cache Analysis</strong></p><p>During the consumer group benchmark, PostgreSQL cache performance was excellent:</p><table tabindex="0"><thead><tr><th>Metric</th><th>Hit Ratio</th></tr></thead><tbody><tr><td><strong>Overall database</strong></td><td>97.47%</td></tr><tr><td><strong>Tables</strong></td><td>97.97%</td></tr><tr><td><strong>Indexes</strong></td><td>95.71%</td></tr></tbody></table><p>The critical hot-path tables achieved <strong>100% cache hit ratio</strong>:</p><ul><li><code>partition_consumers</code>: 95.6B cache hits (cursor positions for all consumer groups)</li><li><code>partition_lookup</code>: 63B cache hits (partition routing)</li><li><code>partitions</code> and <code>queues</code>: 100% cached</li></ul><p>The <code>messages</code> table had a lower hit ratio (62.55%) which is expected — messages are write-once, read-once, and the table is too large to fit entirely in the 1GB <code>shared_buffers</code>. However, the OS page cache (64GB RAM) handles sequential message reads efficiently.</p><p>Buffer cache contents during the benchmark:</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>messages table + indexes: ~950 MB (93% of 1GB shared_buffers)</span></span>
<span class="line"><span>partition_consumers:       29 MB  (2.8%)</span></span>
<span class="line"><span>partition_lookup:           5 MB  (0.5%)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>This explains why disk reads were nearly zero during steady-state operation: all random-access patterns (cursor lookups, partition routing) hit RAM, while sequential message reads were handled by the OS page cache.</p><p><img src="`+y+'" alt="Disk read and write"><em>Disk read and write during the benchmark, write is due to WAL, and no reads because data is inside shared buffers</em></p><h2 id="conclusions" tabindex="-1">Conclusions <a class="header-anchor" href="#conclusions" aria-label="Permalink to &quot;Conclusions&quot;">​</a></h2><p>This is not rocket science and mainly due to my own ignorance, developing Queen in C++ cost me a lot in terms of time and mental health, but now that the end is in sight, I feel I understand mechanisms that I used to know only in theory much better in practice. I hope this document can help someone else do the same. I&#39;m sure Queen can push more than this (I&#39;ve just discovered that I&#39;m using the slowest JSON library in the C++ world, for instance), but I think this is a good starting point.</p><h3 id="references" tabindex="-1">References <a class="header-anchor" href="#references" aria-label="Permalink to &quot;References&quot;">​</a></h3><ul><li><a href="https://github.com/uNetworking/uWebSockets" target="_blank" rel="noreferrer">uWebSockets</a></li><li><a href="https://docs.libuv.org/en/v1.x/" target="_blank" rel="noreferrer">libuv</a></li><li><a href="https://smartpricing.github.io/queen/" target="_blank" rel="noreferrer">queen</a></li></ul>',157)])])}const D=p(F,[["render",b]]);export{_ as __pageData,D as default};
