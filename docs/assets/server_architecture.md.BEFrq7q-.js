import{_ as a,c as n,o as e,ag as i}from"./chunks/framework.-kPtTt-D.js";const b=JSON.parse('{"title":"Server Architecture","description":"","frontmatter":{},"headers":[],"relativePath":"server/architecture.md","filePath":"server/architecture.md"}'),p={name:"server/architecture.md"};function l(t,s,r,o,h,c){return e(),n("div",null,[...s[0]||(s[0]=[i(`<h1 id="server-architecture" tabindex="-1">Server Architecture <a class="header-anchor" href="#server-architecture" aria-label="Permalink to &quot;Server Architecture&quot;">​</a></h1><p>Queen MQ uses a high-performance <strong>acceptor/worker pattern</strong> with fully asynchronous, non-blocking PostgreSQL architecture for maximum throughput and minimal latency.</p><h2 id="system-overview" tabindex="-1">System Overview <a class="header-anchor" href="#system-overview" aria-label="Permalink to &quot;System Overview&quot;">​</a></h2><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>┌────────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│                        CLIENT LAYER                            │</span></span>
<span class="line"><span>│  JavaScript Client, Python Client, C++ Client, HTTP Direct     │</span></span>
<span class="line"><span>└────────────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                              ↓ HTTP</span></span>
<span class="line"><span>┌────────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│                     NETWORK LAYER (uWebSockets)                │</span></span>
<span class="line"><span>│  ┌──────────┐   ┌──────────┐   ┌──────────┐                  │</span></span>
<span class="line"><span>│  │ Acceptor │──→│ Worker 1 │   │ Worker N │  (Event Loops)   │</span></span>
<span class="line"><span>│  └──────────┘   └──────────┘   └──────────┘                  │</span></span>
<span class="line"><span>│                      │              │                          │</span></span>
<span class="line"><span>│                 ┌────┴────┐   ┌────┴────┐                     │</span></span>
<span class="line"><span>│                 │ Sidecar │   │ Sidecar │  (libuv + libpq)    │</span></span>
<span class="line"><span>│                 └─────────┘   └─────────┘                     │</span></span>
<span class="line"><span>└────────────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                              ↓</span></span>
<span class="line"><span>┌────────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│                   PRIMARY OPERATIONS (Sidecar)                 │</span></span>
<span class="line"><span>│              PUSH │ POP │ ACK │ TRANSACTION │ LEASE            │</span></span>
<span class="line"><span>│         High-performance path via libuv + async libpq          │</span></span>
<span class="line"><span>└────────────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                              ↓</span></span>
<span class="line"><span>┌────────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│              SECONDARY OPERATIONS (AsyncQueueManager)          │</span></span>
<span class="line"><span>│     Schema Init │ Queue Config │ Tracing │ Consumer Groups     │</span></span>
<span class="line"><span>│              Maintenance Mode │ File Buffer Replay             │</span></span>
<span class="line"><span>└────────────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                              ↓</span></span>
<span class="line"><span>┌────────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│                    DATABASE LAYER                              │</span></span>
<span class="line"><span>│  ┌──────────────────────────────────────────────────────┐     │</span></span>
<span class="line"><span>│  │  Per-worker Sidecars (libuv event loops + libpq)     │     │</span></span>
<span class="line"><span>│  │  + AsyncDbPool (for secondary operations)            │     │</span></span>
<span class="line"><span>│  └──────────────────────────────────────────────────────┘     │</span></span>
<span class="line"><span>│                            ↓                                   │</span></span>
<span class="line"><span>│              PostgreSQL (Stored Procedures)                    │</span></span>
<span class="line"><span>│   push_messages_v2 │ pop_unified_batch │ ack_messages_v2       │</span></span>
<span class="line"><span>└────────────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                              ↓</span></span>
<span class="line"><span>┌────────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│                  BACKGROUND SERVICES                           │</span></span>
<span class="line"><span>│              Metrics │ Retention │ Eviction                    │</span></span>
<span class="line"><span>└────────────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                              ↓</span></span>
<span class="line"><span>┌────────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│                    FAILOVER LAYER                              │</span></span>
<span class="line"><span>│          File Buffer (Zero message loss on DB failure)         │</span></span>
<span class="line"><span>└────────────────────────────────────────────────────────────────┘</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><h2 id="core-components" tabindex="-1">Core Components <a class="header-anchor" href="#core-components" aria-label="Permalink to &quot;Core Components&quot;">​</a></h2><h3 id="_1-network-layer-uwebsockets" tabindex="-1">1. Network Layer (uWebSockets) <a class="header-anchor" href="#_1-network-layer-uwebsockets" aria-label="Permalink to &quot;1. Network Layer (uWebSockets)&quot;">​</a></h3><h4 id="acceptor-thread" tabindex="-1">Acceptor Thread <a class="header-anchor" href="#acceptor-thread" aria-label="Permalink to &quot;Acceptor Thread&quot;">​</a></h4><ul><li><strong>Single thread</strong> listening on port 6632</li><li><strong>Round-robin distribution</strong> of connections to workers</li><li><strong>Pure routing</strong> - no processing logic</li><li><strong>Non-blocking</strong> operation</li></ul><h4 id="worker-threads" tabindex="-1">Worker Threads <a class="header-anchor" href="#worker-threads" aria-label="Permalink to &quot;Worker Threads&quot;">​</a></h4><ul><li><strong>2 threads by default</strong> (configurable via <code>NUM_WORKERS</code>)</li><li><strong>Event loop</strong> in each worker (uWebSockets + libuv)</li><li><strong>Per-worker sidecar</strong> for async PostgreSQL operations</li><li><strong>Non-blocking I/O</strong> throughout</li></ul><p><strong>Configuration:</strong></p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> NUM_WORKERS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PORT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">6632</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="_2-sidecar-pattern-libuv-libpq" tabindex="-1">2. Sidecar Pattern (libuv + libpq) <a class="header-anchor" href="#_2-sidecar-pattern-libuv-libpq" aria-label="Permalink to &quot;2. Sidecar Pattern (libuv + libpq)&quot;">​</a></h3><p>Each worker has a dedicated <strong>sidecar</strong> that handles all PostgreSQL operations asynchronously using libuv. The sidecar is the heart of Queen&#39;s high-performance database layer.</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>┌─────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│                    Worker Thread                             │</span></span>
<span class="line"><span>│  ┌──────────────────────────────────────────────────────┐   │</span></span>
<span class="line"><span>│  │               uWS Event Loop                          │   │</span></span>
<span class="line"><span>│  │   HTTP Request → Parse → Queue to Sidecar → Wait      │   │</span></span>
<span class="line"><span>│  └──────────────────────────────────────────────────────┘   │</span></span>
<span class="line"><span>│                           ↕ uv_async                         │</span></span>
<span class="line"><span>│  ┌──────────────────────────────────────────────────────┐   │</span></span>
<span class="line"><span>│  │                  Sidecar (libuv)                      │   │</span></span>
<span class="line"><span>│  │   ┌─────────┐  ┌─────────┐  ┌─────────────────────┐  │   │</span></span>
<span class="line"><span>│  │   │  Timer  │  │  Async  │  │   Poll Handles      │  │   │</span></span>
<span class="line"><span>│  │   │ (batch) │  │ (wake)  │  │  (PG sockets)       │  │   │</span></span>
<span class="line"><span>│  │   └─────────┘  └─────────┘  └─────────────────────┘  │   │</span></span>
<span class="line"><span>│  │                       ↓                               │   │</span></span>
<span class="line"><span>│  │               PostgreSQL Connections                  │   │</span></span>
<span class="line"><span>│  └──────────────────────────────────────────────────────┘   │</span></span>
<span class="line"><span>└─────────────────────────────────────────────────────────────┘</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h4 id="libuv-components" tabindex="-1">libuv Components <a class="header-anchor" href="#libuv-components" aria-label="Permalink to &quot;libuv Components&quot;">​</a></h4><table tabindex="0"><thead><tr><th>Component</th><th>Purpose</th><th>How It&#39;s Used</th></tr></thead><tbody><tr><td><code>uv_poll</code></td><td>Socket monitoring</td><td>Watch PostgreSQL connection file descriptors for read/write events</td></tr><tr><td><code>uv_timer</code> (batch)</td><td>Micro-batching</td><td>Accumulate requests for 5ms before sending to maximize throughput</td></tr><tr><td><code>uv_timer</code> (waiting)</td><td>Long-polling</td><td>Check for messages at configurable intervals with exponential backoff</td></tr><tr><td><code>uv_async</code></td><td>Cross-thread wakeup</td><td>Signal sidecar when HTTP thread receives a request</td></tr></tbody></table><h4 id="operation-specific-behavior" tabindex="-1">Operation-Specific Behavior <a class="header-anchor" href="#operation-specific-behavior" aria-label="Permalink to &quot;Operation-Specific Behavior&quot;">​</a></h4><p>The sidecar treats different operations differently for optimal performance:</p><table tabindex="0"><thead><tr><th>Operation</th><th>Signal Behavior</th><th>Why</th></tr></thead><tbody><tr><td><strong>PUSH</strong></td><td>Buffer only (no immediate wake)</td><td>Allows maximum batching for throughput</td></tr><tr><td><strong>POP</strong></td><td>Immediate wake + drain</td><td>Latency-sensitive, needs fast response</td></tr><tr><td><strong>ACK</strong></td><td>Immediate wake + drain</td><td>Consumers waiting for acknowledgment</td></tr><tr><td><strong>POP_WAIT</strong></td><td>Goes to waiting queue</td><td>Separate timer-based polling</td></tr></tbody></table><p><strong>PUSH Optimization:</strong> When a PUSH request arrives, it&#39;s added to the pending queue but does <em>not</em> wake up the sidecar immediately. This allows multiple PUSH requests to accumulate and be batched together when the batch timer fires, significantly improving throughput.</p><p><strong>Configuration:</strong></p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SIDECAR_POOL_SIZE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">50</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">              # Total sidecar connections (split among workers)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SIDECAR_MICRO_BATCH_WAIT_MS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     # Batching window</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SIDECAR_MAX_ITEMS_PER_TX</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1000</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     # Max items per transaction</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># POP_WAIT backoff (long-polling)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> POP_WAIT_INITIAL_INTERVAL_MS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">100</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # Initial poll interval</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> POP_WAIT_BACKOFF_THRESHOLD</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      # Empty checks before backoff</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> POP_WAIT_BACKOFF_MULTIPLIER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2.0</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   # Exponential multiplier</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> POP_WAIT_MAX_INTERVAL_MS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1000</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     # Max interval after backoff</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_3-unified-pop-batch-single-round-trip" tabindex="-1">3. Unified POP Batch (Single Round-Trip) <a class="header-anchor" href="#_3-unified-pop-batch-single-round-trip" aria-label="Permalink to &quot;3. Unified POP Batch (Single Round-Trip)&quot;">​</a></h3><p>POP operations use a <strong>unified batch procedure</strong> that handles lease acquisition, message fetching, and cleanup in a single database call. This eliminates multiple round-trips and simplifies the architecture.</p><h4 id="how-it-works" tabindex="-1">How It Works <a class="header-anchor" href="#how-it-works" aria-label="Permalink to &quot;How It Works&quot;">​</a></h4><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>POP requests arrive</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>    Sidecar combines into JSON array</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>    1 SQL call: SELECT queen.pop_unified_batch($1::jsonb)</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>    PostgreSQL handles in single transaction:</span></span>
<span class="line"><span>      - Acquire leases (SKIP LOCKED for wildcards)</span></span>
<span class="line"><span>      - Fetch messages after cursor position</span></span>
<span class="line"><span>      - Release empty leases automatically</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>    Return results as JSON</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>Key features:</strong></p><ul><li><strong>Single round-trip</strong>: Lease + fetch + cleanup in one call</li><li><strong>SKIP LOCKED</strong>: Wildcard POPs don&#39;t block each other</li><li><strong>Automatic cleanup</strong>: Empty leases released immediately</li><li><strong>Deadlock-safe</strong>: Consistent ordering prevents deadlocks</li></ul><h4 id="performance" tabindex="-1">Performance <a class="header-anchor" href="#performance" aria-label="Permalink to &quot;Performance&quot;">​</a></h4><table tabindex="0"><thead><tr><th>Metric</th><th>Value</th></tr></thead><tbody><tr><td>POP throughput</td><td>50,000+ ops/s</td></tr><tr><td>p50 latency</td><td>3-10ms</td></tr><tr><td>p99 latency</td><td>15-30ms</td></tr><tr><td>Connection utilization</td><td>80%+</td></tr></tbody></table><h3 id="_4-database-layer-asyncdbpool" tabindex="-1">4. Database Layer (AsyncDbPool) <a class="header-anchor" href="#_4-database-layer-asyncdbpool" aria-label="Permalink to &quot;4. Database Layer (AsyncDbPool)&quot;">​</a></h3><p>The AsyncDbPool provides <strong>non-blocking PostgreSQL connections</strong> for background services.</p><p><strong>Key Features:</strong></p><ul><li><strong>95% of DB_POOL_SIZE</strong> for async operations</li><li><strong>Socket-based I/O</strong> with non-blocking libpq</li><li><strong>RAII-based</strong> resource management</li><li><strong>Connection health monitoring</strong> with automatic reset</li></ul><p><strong>Configuration:</strong></p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DB_POOL_SIZE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">150</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          # Total connections (95% = 142 async)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DB_IDLE_TIMEOUT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">30000</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     # Idle timeout (ms)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DB_STATEMENT_TIMEOUT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">30000</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # Query timeout (ms)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="_5-asyncqueuemanager-secondary-operations" tabindex="-1">5. AsyncQueueManager (Secondary Operations) <a class="header-anchor" href="#_5-asyncqueuemanager-secondary-operations" aria-label="Permalink to &quot;5. AsyncQueueManager (Secondary Operations)&quot;">​</a></h3><p>Handles administrative and secondary operations that don&#39;t need the high-performance sidecar path.</p><p><strong>Operations:</strong></p><ul><li><strong>Schema initialization</strong> - Database setup and migrations</li><li><strong>Queue configuration</strong> - Create/update queue settings</li><li><strong>Consumer group management</strong> - Subscription metadata, group deletion</li><li><strong>Message tracing</strong> - Record and query traces</li><li><strong>Maintenance mode</strong> - Toggle and status</li><li><strong>File buffer replay</strong> - Internal push operations</li></ul><p><strong>Primary operations (PUSH, POP, ACK)</strong> go through the Sidecar for maximum performance.</p><h3 id="_6-background-services" tabindex="-1">6. Background Services <a class="header-anchor" href="#_6-background-services" aria-label="Permalink to &quot;6. Background Services&quot;">​</a></h3><p>Queen runs three background services for housekeeping:</p><h4 id="metricscollector" tabindex="-1">MetricsCollector <a class="header-anchor" href="#metricscollector" aria-label="Permalink to &quot;MetricsCollector&quot;">​</a></h4><ul><li><strong>System metrics</strong> - CPU, memory, connections</li><li><strong>Queue metrics</strong> - Depths, throughput, latencies</li><li><strong>Sampling</strong> - 1 second sample interval, 60 second aggregation</li><li><strong>Storage</strong> - PostgreSQL <code>queen.metrics_history</code> table</li></ul><h4 id="retentionservice" tabindex="-1">RetentionService <a class="header-anchor" href="#retentionservice" aria-label="Permalink to &quot;RetentionService&quot;">​</a></h4><ul><li><strong>Message cleanup</strong> - Delete expired messages (TTL-based)</li><li><strong>Partition cleanup</strong> - Remove empty partitions older than N days</li><li><strong>Metrics cleanup</strong> - Prune old metrics history</li><li><strong>Batch processing</strong> - Configurable batch size to avoid long locks</li></ul><h4 id="evictionservice" tabindex="-1">EvictionService <a class="header-anchor" href="#evictionservice" aria-label="Permalink to &quot;EvictionService&quot;">​</a></h4><ul><li><strong>Max wait time</strong> - Evict messages exceeding <code>max_wait_time_seconds</code></li><li><strong>Periodic check</strong> - Every 60 seconds (configurable)</li><li><strong>DLQ routing</strong> - Evicted messages go to dead letter queue if configured</li></ul><p><strong>Configuration:</strong></p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> METRICS_SAMPLE_INTERVAL_MS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1000</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> METRICS_AGGREGATE_INTERVAL_S</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">60</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RETENTION_INTERVAL</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">300000</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         # 5 minutes</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RETENTION_BATCH_SIZE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1000</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         # Messages per batch</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PARTITION_CLEANUP_DAYS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          # Days before removing empty partitions</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> METRICS_RETENTION_DAYS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">30</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         # Days to keep metrics history</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> EVICTION_INTERVAL</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">60000</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">           # 1 minute</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> EVICTION_BATCH_SIZE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">100</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">           # Messages per eviction batch</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="_7-inter-instance-communication-udp" tabindex="-1">7. Inter-Instance Communication (UDP) <a class="header-anchor" href="#_7-inter-instance-communication-udp" aria-label="Permalink to &quot;7. Inter-Instance Communication (UDP)&quot;">​</a></h3><p>In clustered deployments, servers notify each other via UDP when messages are pushed or acknowledged.</p><p><strong>Notification Types:</strong></p><table tabindex="0"><thead><tr><th>Event</th><th>Notification</th><th>Effect</th></tr></thead><tbody><tr><td>PUSH (message queued)</td><td><code>MESSAGE_AVAILABLE</code></td><td>Wake waiting consumers</td></tr><tr><td>ACK (partition freed)</td><td><code>PARTITION_FREE</code></td><td>Wake consumers for partition</td></tr></tbody></table><p><strong>Configuration:</strong></p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> QUEEN_UDP_PEERS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;queen-b:6633,queen-c:6633&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> QUEEN_UDP_NOTIFY_PORT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">6633</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>Latency Impact:</strong></p><table tabindex="0"><thead><tr><th>Scenario</th><th>Without Notifications</th><th>With UDP Notifications</th></tr></thead><tbody><tr><td>Cross-server message delivery</td><td>Up to 5000ms (backoff)</td><td>10-50ms</td></tr></tbody></table><h3 id="_8-failover-layer-file-buffer" tabindex="-1">8. Failover Layer (File Buffer) <a class="header-anchor" href="#_8-failover-layer-file-buffer" aria-label="Permalink to &quot;8. Failover Layer (File Buffer)&quot;">​</a></h3><p><strong>Zero message loss</strong> when PostgreSQL is unavailable.</p><p><strong>Flow:</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Normal Operation:</span></span>
<span class="line"><span>  PUSH → Sidecar → PostgreSQL → Success</span></span>
<span class="line"><span></span></span>
<span class="line"><span>PostgreSQL Down:</span></span>
<span class="line"><span>  PUSH → Detect failure</span></span>
<span class="line"><span>       → Write to file buffer (.buf.tmp)</span></span>
<span class="line"><span>       → Rotate to .buf when complete</span></span>
<span class="line"><span>       → Return success to client</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Recovery:</span></span>
<span class="line"><span>  Background processor detects DB available</span></span>
<span class="line"><span>    → Read oldest .buf file</span></span>
<span class="line"><span>    → Replay events to PostgreSQL</span></span>
<span class="line"><span>    → Delete file on success</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><strong>Configuration:</strong></p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_BUFFER_DIR</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/var/lib/queen/buffers  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Linux default</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_BUFFER_FLUSH_MS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">100</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_BUFFER_MAX_BATCH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">100</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_BUFFER_EVENTS_PER_FILE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10000</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="request-flow-examples" tabindex="-1">Request Flow Examples <a class="header-anchor" href="#request-flow-examples" aria-label="Permalink to &quot;Request Flow Examples&quot;">​</a></h2><h3 id="push-operation" tabindex="-1">PUSH Operation <a class="header-anchor" href="#push-operation" aria-label="Permalink to &quot;PUSH Operation&quot;">​</a></h3><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>1. Client sends HTTP POST to /api/v1/push</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>2. Acceptor routes to Worker (round-robin)</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>3. Worker parses JSON, registers in ResponseRegistry</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>4. Worker queues request to Sidecar</span></span>
<span class="line"><span>   (PUSH does NOT call uv_async_send - relies on batch timer)</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>5. Sidecar batch timer fires (every 5ms)</span></span>
<span class="line"><span>   Collects all pending PUSH requests</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>6. Sidecar calls: SELECT queen.push_messages_v2($1)</span></span>
<span class="line"><span>   PQsendQueryParams() (non-blocking)</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>7. uv_poll monitors socket for response</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>8. Result ready → parse JSONB → deliver to worker</span></span>
<span class="line"><span>   uWS::Loop::defer() (thread-safe)</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>9. Worker sends HTTP 201 response</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Total time: 10-50ms (typical)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="pop-operation" tabindex="-1">POP Operation <a class="header-anchor" href="#pop-operation" aria-label="Permalink to &quot;POP Operation&quot;">​</a></h3><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>1. Client sends GET to /api/v1/pop?partition=orders-123</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>2. Worker registers in ResponseRegistry</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>3. Sidecar batches POP requests</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>4. Single call: SELECT queen.pop_unified_batch($1::jsonb)</span></span>
<span class="line"><span>   PostgreSQL:</span></span>
<span class="line"><span>     - Acquires lease (atomic UPDATE)</span></span>
<span class="line"><span>     - Fetches messages after cursor</span></span>
<span class="line"><span>     - Releases lease if empty</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>5. Messages returned as JSON</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>6. Response delivered to HTTP thread</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Total time: 3-10ms (typical)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="pop-with-wait-long-polling" tabindex="-1">POP with Wait (Long-Polling) <a class="header-anchor" href="#pop-with-wait-long-polling" aria-label="Permalink to &quot;POP with Wait (Long-Polling)&quot;">​</a></h3><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>1. Client sends GET to /api/v1/pop?wait=true&amp;timeout=30000</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>2. Worker registers in ResponseRegistry</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>3. Sidecar submits POP_WAIT request to waiting queue</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>4. Sidecar polls database periodically:</span></span>
<span class="line"><span>   - Initial: 100ms interval</span></span>
<span class="line"><span>   - Backoff: 100ms → 200ms → ... → 1000ms</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>5. SharedStateManager notifies on PUSH events</span></span>
<span class="line"><span>   → Sidecar wakes immediately, resets backoff</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>6. Messages found → HTTP 200</span></span>
<span class="line"><span>   OR timeout → HTTP 204 No Content</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="performance-characteristics" tabindex="-1">Performance Characteristics <a class="header-anchor" href="#performance-characteristics" aria-label="Permalink to &quot;Performance Characteristics&quot;">​</a></h2><h3 id="latency" tabindex="-1">Latency <a class="header-anchor" href="#latency" aria-label="Permalink to &quot;Latency&quot;">​</a></h3><table tabindex="0"><thead><tr><th>Operation</th><th>Latency</th><th>Notes</th></tr></thead><tbody><tr><td>PUSH (single)</td><td>5-15ms</td><td>Batched via timer</td></tr><tr><td>PUSH (batch)</td><td>10-30ms</td><td>Micro-batched</td></tr><tr><td>POP (immediate)</td><td>3-10ms</td><td>State machine parallel</td></tr><tr><td>POP (long-poll)</td><td>10ms-30s</td><td>Configurable timeout</td></tr><tr><td>ACK (single)</td><td>5-15ms</td><td>Via sidecar</td></tr><tr><td>ACK (batch)</td><td>10-30ms</td><td>Micro-batched</td></tr><tr><td>TRANSACTION</td><td>30-100ms</td><td>Multiple operations</td></tr></tbody></table><h3 id="throughput" tabindex="-1">Throughput <a class="header-anchor" href="#throughput" aria-label="Permalink to &quot;Throughput&quot;">​</a></h3><table tabindex="0"><thead><tr><th>Metric</th><th>Value</th><th>Configuration</th></tr></thead><tbody><tr><td>PUSH sustained</td><td>130K+ msg/s</td><td>Batch operations</td></tr><tr><td>POP sustained</td><td>50K+ ops/s</td><td>State machine parallel</td></tr><tr><td>Peak</td><td>148K+ msg/s</td><td>Large batches</td></tr><tr><td>Single message</td><td>2-5K msg/s</td><td>No batching</td></tr></tbody></table><h3 id="resource-usage" tabindex="-1">Resource Usage <a class="header-anchor" href="#resource-usage" aria-label="Permalink to &quot;Resource Usage&quot;">​</a></h3><table tabindex="0"><thead><tr><th>Resource</th><th>Default</th><th>Notes</th></tr></thead><tbody><tr><td>Worker threads</td><td>2</td><td><code>NUM_WORKERS</code></td></tr><tr><td>AsyncDbPool connections</td><td>50</td><td><code>DB_POOL_SIZE</code> (for secondary ops)</td></tr><tr><td>Sidecar connections</td><td>50</td><td><code>SIDECAR_POOL_SIZE</code> (split among workers)</td></tr><tr><td>Thread pool</td><td>4 threads</td><td>Database operations</td></tr><tr><td>System thread pool</td><td>2 threads</td><td>Background services</td></tr></tbody></table><h2 id="scalability" tabindex="-1">Scalability <a class="header-anchor" href="#scalability" aria-label="Permalink to &quot;Scalability&quot;">​</a></h2><h3 id="horizontal-scaling" tabindex="-1">Horizontal Scaling <a class="header-anchor" href="#horizontal-scaling" aria-label="Permalink to &quot;Horizontal Scaling&quot;">​</a></h3><p>Deploy multiple server instances behind a load balancer:</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>┌─────────────┐</span></span>
<span class="line"><span>│    Load     │</span></span>
<span class="line"><span>│  Balancer   │</span></span>
<span class="line"><span>└──────┬──────┘</span></span>
<span class="line"><span>       │</span></span>
<span class="line"><span>   ┌───┼────┬────────┐</span></span>
<span class="line"><span>   ↓   ↓    ↓        ↓</span></span>
<span class="line"><span>Server1 Server2 Server3 ... ServerN</span></span>
<span class="line"><span>   │    │    │        │</span></span>
<span class="line"><span>   └────┴────┴────────┘</span></span>
<span class="line"><span>          ↓</span></span>
<span class="line"><span>    PostgreSQL</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>Benefits:</strong></p><ul><li>✅ Linear scaling of request handling</li><li>✅ Shared PostgreSQL (no data sharding)</li><li>✅ Session-less design (any server handles any request)</li><li>✅ UDP notifications for cross-server coordination</li></ul><h3 id="vertical-scaling" tabindex="-1">Vertical Scaling <a class="header-anchor" href="#vertical-scaling" aria-label="Permalink to &quot;Vertical Scaling&quot;">​</a></h3><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># More workers</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> NUM_WORKERS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DB_POOL_SIZE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">300</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SIDECAR_POOL_SIZE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">100</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="design-principles" tabindex="-1">Design Principles <a class="header-anchor" href="#design-principles" aria-label="Permalink to &quot;Design Principles&quot;">​</a></h2><ol><li><strong>Non-blocking I/O</strong> - All database operations use async libpq + libuv</li><li><strong>Event-driven</strong> - Worker threads never block on I/O</li><li><strong>Micro-batching</strong> - Amortize overhead across multiple requests</li><li><strong>Operation-specific optimization</strong> - PUSH buffers, POP parallelizes</li><li><strong>Stored procedures</strong> - Complex logic in PostgreSQL (single round-trip)</li><li><strong>Fail-safe</strong> - Automatic failover to file buffer</li><li><strong>Horizontal scalability</strong> - Stateless server design with UDP coordination</li></ol><h2 id="configuration-summary" tabindex="-1">Configuration Summary <a class="header-anchor" href="#configuration-summary" aria-label="Permalink to &quot;Configuration Summary&quot;">​</a></h2><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Server</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PORT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">6632</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> NUM_WORKERS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Database (secondary operations)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DB_POOL_SIZE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">50</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DB_STATEMENT_TIMEOUT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">30000</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Sidecar (primary operations)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SIDECAR_POOL_SIZE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">50</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SIDECAR_MICRO_BATCH_WAIT_MS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SIDECAR_MAX_ITEMS_PER_TX</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1000</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Background services</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> METRICS_SAMPLE_INTERVAL_MS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1000</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RETENTION_INTERVAL</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">300000</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> EVICTION_INTERVAL</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">60000</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Inter-instance (clustered)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> QUEEN_UDP_PEERS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;queen-b:6633,queen-c:6633&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> QUEEN_UDP_NOTIFY_PORT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">6633</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Failover</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_BUFFER_DIR</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/var/lib/queen/buffers</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h2 id="see-also" tabindex="-1">See Also <a class="header-anchor" href="#see-also" aria-label="Permalink to &quot;See Also&quot;">​</a></h2><ul><li><a href="/queen/server/how-it-works.html">How It Works</a> - Deep dive into uWebSockets, libuv, Sidecar pattern, and PostgreSQL stored procedures</li><li><a href="/queen/server/environment-variables.html">Environment Variables</a> - Complete configuration reference</li><li><a href="/queen/server/tuning.html">Performance Tuning</a> - Optimization guide</li><li><a href="/queen/server/deployment.html">Deployment</a> - Production deployment patterns</li></ul>`,94)])])}const u=a(p,[["render",l]]);export{b as __pageData,u as default};
