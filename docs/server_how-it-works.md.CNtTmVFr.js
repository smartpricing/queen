import{_ as a,c as n,o as i,ag as e}from"./chunks/framework.-kPtTt-D.js";const d=JSON.parse('{"title":"How It Works","description":"","frontmatter":{},"headers":[],"relativePath":"server/how-it-works.md","filePath":"server/how-it-works.md"}'),l={name:"server/how-it-works.md"};function p(t,s,r,h,k,o){return i(),n("div",null,[...s[0]||(s[0]=[e(`<h1 id="how-it-works" tabindex="-1">How It Works <a class="header-anchor" href="#how-it-works" aria-label="Permalink to &quot;How It Works&quot;">​</a></h1><p>This page provides a deep dive into Queen&#39;s internals — the asynchronous architecture, libuv integration, PostgreSQL stored procedures, and the microbatching strategy that enables 130K+ msg/s throughput.</p><h2 id="overview" tabindex="-1">Overview <a class="header-anchor" href="#overview" aria-label="Permalink to &quot;Overview&quot;">​</a></h2><p>Queen is built on three core principles:</p><ol><li><strong>Non-blocking I/O everywhere</strong> — No thread ever blocks waiting for a database response</li><li><strong>Microbatching</strong> — Multiple HTTP requests are combined into single PostgreSQL calls</li><li><strong>Stored procedures</strong> — Complex logic runs in PostgreSQL, minimizing round-trips</li></ol><p>The result is a system that can handle tens of thousands of concurrent connections with minimal latency and maximum throughput.</p><h2 id="the-acceptor-worker-pattern" tabindex="-1">The Acceptor/Worker Pattern <a class="header-anchor" href="#the-acceptor-worker-pattern" aria-label="Permalink to &quot;The Acceptor/Worker Pattern&quot;">​</a></h2><p>Queen uses a multi-threaded architecture where each component has a specific responsibility:</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>                              ┌─────────────────────────────────────────┐</span></span>
<span class="line"><span>                              │            QUEEN SERVER                  │</span></span>
<span class="line"><span>                              └─────────────────────────────────────────┘</span></span>
<span class="line"><span>                                                │</span></span>
<span class="line"><span>                                                ▼</span></span>
<span class="line"><span>                              ┌─────────────────────────────────────────┐</span></span>
<span class="line"><span>                              │     ACCEPTOR (port 6632, round-robin)   │</span></span>
<span class="line"><span>                              │          uWebSockets event loop         │</span></span>
<span class="line"><span>                              └──────┬──────────┬──────────┬────────────┘</span></span>
<span class="line"><span>                                     │          │          │</span></span>
<span class="line"><span>          ┌──────────────────────────┼──────────┼──────────┼─────────────────────────┐</span></span>
<span class="line"><span>          │                          │          │          │                         │</span></span>
<span class="line"><span>          ▼                          ▼          ▼          ▼                         ▼</span></span>
<span class="line"><span>┌──────────────────┐      ┌──────────────────┐      ┌──────────────────┐      ┌──────────────────┐</span></span>
<span class="line"><span>│   UWS WORKER 0   │      │   UWS WORKER 1   │      │   UWS WORKER 2   │      │   UWS WORKER N   │</span></span>
<span class="line"><span>│   (event loop)   │      │   (event loop)   │      │   (event loop)   │      │   (event loop)   │</span></span>
<span class="line"><span>│        │         │      │        │         │      │        │         │      │        │         │</span></span>
<span class="line"><span>│        ▼         │      │        ▼         │      │        ▼         │      │        ▼         │</span></span>
<span class="line"><span>│  ┌────────────┐  │      │  ┌────────────┐  │      │  ┌────────────┐  │      │  ┌────────────┐  │</span></span>
<span class="line"><span>│  │ libqueen 0 │  │      │  │ libqueen 1 │  │      │  │ libqueen 2 │  │      │  │ libqueen N │  │</span></span>
<span class="line"><span>│  │ (libuv)    │  │      │  │ (libuv)    │  │      │  │ (libuv)    │  │      │  │ (libuv)    │  │</span></span>
<span class="line"><span>│  │     │      │  │      │  │     │      │  │      │  │     │      │  │      │  │     │      │  │</span></span>
<span class="line"><span>│  │     ▼      │  │      │  │     ▼      │  │      │  │     ▼      │  │      │  │     ▼      │  │</span></span>
<span class="line"><span>│  │ PG Pool    │  │      │  │ PG Pool    │  │      │  │ PG Pool    │  │      │  │ PG Pool    │  │</span></span>
<span class="line"><span>│  └────────────┘  │      │  └────────────┘  │      │  └────────────┘  │      │  └────────────┘  │</span></span>
<span class="line"><span>└──────────────────┘      └──────────────────┘      └──────────────────┘      └──────────────────┘</span></span>
<span class="line"><span>          │                          │                        │                        │</span></span>
<span class="line"><span>          └──────────────────────────┴────────────────────────┴────────────────────────┘</span></span>
<span class="line"><span>                                                │</span></span>
<span class="line"><span>                                                ▼</span></span>
<span class="line"><span>                                    ┌──────────────────────┐</span></span>
<span class="line"><span>                                    │      PostgreSQL      │</span></span>
<span class="line"><span>                                    │   (N×M connections)  │</span></span>
<span class="line"><span>                                    └──────────────────────┘</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><h3 id="_1-acceptor-thread" tabindex="-1">1. Acceptor Thread <a class="header-anchor" href="#_1-acceptor-thread" aria-label="Permalink to &quot;1. Acceptor Thread&quot;">​</a></h3><p>A single thread that listens on port 6632 and distributes connections to workers in round-robin fashion. It performs pure routing with no processing logic:</p><div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Acceptor distributes connections round-robin</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">acceptor-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">listen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(host, port, [](</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">auto*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> listen_socket</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // All workers registered via addChildApp()</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // uWebSockets handles round-robin internally</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="_2-uwebsockets-workers" tabindex="-1">2. uWebSockets Workers <a class="header-anchor" href="#_2-uwebsockets-workers" aria-label="Permalink to &quot;2. uWebSockets Workers&quot;">​</a></h3><p>Each worker is a thread with its own <a href="https://github.com/uNetworking/uWebSockets" target="_blank" rel="noreferrer">uWebSockets</a> event loop. When an HTTP request arrives:</p><ol><li>Parse the request</li><li>Register in ResponseRegistry (maps <code>request_id</code> → HTTP response)</li><li>Push the operation onto a mutex-protected queue for libqueen</li><li><strong>Return immediately</strong> — the HTTP response will be sent when PostgreSQL responds</li></ol><p>Workers never block on I/O. They hand off work and continue processing other requests.</p><h3 id="_3-libqueen-—-the-async-database-layer" tabindex="-1">3. libqueen — The Async Database Layer <a class="header-anchor" href="#_3-libqueen-—-the-async-database-layer" aria-label="Permalink to &quot;3. libqueen — The Async Database Layer&quot;">​</a></h3><p>This is where the magic happens. Each uWS worker has its own <strong>libqueen</strong> instance running in a separate thread with its own <a href="https://libuv.org/" target="_blank" rel="noreferrer">libuv</a> event loop.</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>┌─────────────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│                        libqueen instance                             │</span></span>
<span class="line"><span>│                                                                      │</span></span>
<span class="line"><span>│   ┌──────────────┐   ┌──────────────┐   ┌──────────────────┐        │</span></span>
<span class="line"><span>│   │ submit_signal│   │ batch_timer  │   │  waiting_timer   │        │</span></span>
<span class="line"><span>│   │  (uv_async)  │   │  (uv_timer)  │   │   (uv_timer)     │        │</span></span>
<span class="line"><span>│   │              │   │   5ms cycle  │   │  100ms-5000ms    │        │</span></span>
<span class="line"><span>│   └──────┬───────┘   └──────┬───────┘   └────────┬─────────┘        │</span></span>
<span class="line"><span>│          │                  │                    │                   │</span></span>
<span class="line"><span>│          └────────┬─────────┴────────────────────┘                   │</span></span>
<span class="line"><span>│                   ↓                                                  │</span></span>
<span class="line"><span>│   ┌───────────────────────────────────────────────────────┐         │</span></span>
<span class="line"><span>│   │              pending_requests_ queue                   │         │</span></span>
<span class="line"><span>│   │   [PUSH] [PUSH] [ACK] [PUSH] [POP] [ACK] [PUSH]       │         │</span></span>
<span class="line"><span>│   └───────────────────────────────────────────────────────┘         │</span></span>
<span class="line"><span>│                   ↓ drain_pending_to_slots()                         │</span></span>
<span class="line"><span>│   ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐                   │</span></span>
<span class="line"><span>│   │ Slot 0  │ │ Slot 1  │ │ Slot 2  │ │ Slot N  │                   │</span></span>
<span class="line"><span>│   │  PGconn │ │  PGconn │ │  PGconn │ │  PGconn │                   │</span></span>
<span class="line"><span>│   │uv_poll_t│ │uv_poll_t│ │uv_poll_t│ │uv_poll_t│                   │</span></span>
<span class="line"><span>│   └─────────┘ └─────────┘ └─────────┘ └─────────┘                   │</span></span>
<span class="line"><span>└─────────────────────────────────────────────────────────────────────┘</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p><strong>How libqueen processes requests:</strong></p><ol><li><strong>Timer fires every 5ms</strong> — Collects all pending operations from the queue</li><li><strong>Groups operations by type</strong> — PUSH, POP, ACK, TRANSACTION, RENEW_LEASE</li><li><strong>Combines each group into a single JSONB array</strong> — Microbatching: 1000 HTTP requests → 1 PostgreSQL call</li><li><strong>Sends one query per type</strong> — Each stored procedure accepts the batched array</li><li><strong>Monitors PostgreSQL sockets with <code>uv_poll</code></strong> — Non-blocking read/write</li><li><strong>Dispatches results by index</strong> — Each result has an <code>idx</code> field matching the original request</li><li><strong>Invokes callbacks when PostgreSQL responds</strong> — Delivers results to HTTP thread via <code>uWS::Loop::defer()</code></li></ol><h3 id="libuv-primitives-used" tabindex="-1">libuv Primitives Used <a class="header-anchor" href="#libuv-primitives-used" aria-label="Permalink to &quot;libuv Primitives Used&quot;">​</a></h3><table tabindex="0"><thead><tr><th>Component</th><th>Purpose</th></tr></thead><tbody><tr><td><code>uv_poll</code></td><td>Monitor PostgreSQL connection sockets for read/write events</td></tr><tr><td><code>uv_timer</code> (batch)</td><td>Accumulate requests for 5ms before sending (microbatching)</td></tr><tr><td><code>uv_timer</code> (stats)</td><td>Periodic metrics collection and stale backoff cleanup</td></tr><tr><td><code>uv_async</code> (reconnect)</td><td>Signal event loop when background thread reconnects a connection</td></tr><tr><td><code>uv_async</code> (backoff)</td><td>Wake waiting consumers when UDP notifications arrive</td></tr></tbody></table><h3 id="why-1-libqueen-per-1-uws-worker" tabindex="-1">Why 1 libqueen per 1 uWS Worker? <a class="header-anchor" href="#why-1-libqueen-per-1-uws-worker" aria-label="Permalink to &quot;Why 1 libqueen per 1 uWS Worker?&quot;">​</a></h3><p>The alternative would be a single shared libqueen instance for all workers. But this would create:</p><ul><li><strong>Lock contention</strong> on the shared queue</li><li><strong>Single libuv loop</strong> becoming the bottleneck</li><li><strong>More complexity</strong> in callback management</li></ul><p>With the 1:1 approach, each worker is <strong>completely independent</strong>. If you have 12 workers, you have 12 libuv loops running in parallel, each with its own pool of PostgreSQL connections. <strong>Workers never talk to each other.</strong></p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 12 workers = 12 libqueen instances = 12 × 50 = 600 PostgreSQL connections</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> NUM_WORKERS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">12</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SIDECAR_POOL_SIZE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">50</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="microbatching-the-performance-secret" tabindex="-1">Microbatching: The Performance Secret <a class="header-anchor" href="#microbatching-the-performance-secret" aria-label="Permalink to &quot;Microbatching: The Performance Secret&quot;">​</a></h2><p>The key to Queen&#39;s performance is <strong>microbatching</strong> — combining multiple client requests into a single database call.</p><h3 id="how-it-works-1" tabindex="-1">How It Works <a class="header-anchor" href="#how-it-works-1" aria-label="Permalink to &quot;How It Works&quot;">​</a></h3><p>When any request arrives (PUSH, POP, ACK, etc.), it doesn&#39;t go to the database immediately. Instead:</p><ol><li>Request is added to the pending queue</li><li>libqueen&#39;s 5ms timer fires</li><li>All pending requests are grouped by operation type</li><li>Each group is combined into a single JSONB array</li><li>One stored procedure call is made per operation type</li></ol><p><strong>Example:</strong> 1000 clients each push 1 message in a 5ms window:</p><ul><li>Without batching: 1000 database round-trips</li><li>With batching: 1 database round-trip with 1000 messages</li></ul><p><strong>Example:</strong> 100 POP requests + 50 ACK requests arrive in a 5ms window:</p><ul><li>Without batching: 150 database round-trips</li><li>With batching: 2 database round-trips (1 for POPs, 1 for ACKs)</li></ul><h3 id="all-operations-are-batched" tabindex="-1">All Operations Are Batched <a class="header-anchor" href="#all-operations-are-batched" aria-label="Permalink to &quot;All Operations Are Batched&quot;">​</a></h3><p>Every operation type is batched the same way — combined into a single JSONB array and sent to PostgreSQL:</p><table tabindex="0"><thead><tr><th>Operation</th><th>Stored Procedure</th><th>Batchable</th></tr></thead><tbody><tr><td><strong>PUSH</strong></td><td><code>queen.push_messages_v2($1::jsonb)</code></td><td>✅ Yes</td></tr><tr><td><strong>POP</strong></td><td><code>queen.pop_unified_batch($1::jsonb)</code></td><td>✅ Yes</td></tr><tr><td><strong>ACK</strong></td><td><code>queen.ack_messages_v2($1::jsonb)</code></td><td>✅ Yes</td></tr><tr><td><strong>TRANSACTION</strong></td><td><code>queen.execute_transaction_v2($1::jsonb)</code></td><td>✅ Yes</td></tr><tr><td><strong>RENEW_LEASE</strong></td><td><code>queen.renew_lease_v2($1::jsonb)</code></td><td>✅ Yes</td></tr><tr><td><strong>CUSTOM</strong></td><td>User-provided SQL</td><td>❌ No (one per slot)</td></tr></tbody></table><p>All operations are queued and processed when the 5ms timer fires. The timer drains the queue, groups jobs by type, and sends each group as a single batched call to PostgreSQL.</p><h2 id="postgresql-stored-procedures" tabindex="-1">PostgreSQL Stored Procedures <a class="header-anchor" href="#postgresql-stored-procedures" aria-label="Permalink to &quot;PostgreSQL Stored Procedures&quot;">​</a></h2><p>Queen pushes complex logic into PostgreSQL stored procedures, reducing round-trips and leveraging PostgreSQL&#39;s transactional guarantees.</p><h3 id="push-messages" tabindex="-1">Push Messages <a class="header-anchor" href="#push-messages" aria-label="Permalink to &quot;Push Messages&quot;">​</a></h3><p>The <code>queen.push_messages_v2</code> procedure handles batch inserts with automatic queue/partition creation and duplicate detection:</p><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE OR REPLACE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FUNCTION</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> queen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.push_messages_v2(p_items jsonb)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RETURNS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> jsonb</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">LANGUAGE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> plpgsql</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $$</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">BEGIN</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    -- Create temp table from input JSON (single pass)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    CREATE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TEMP </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TABLE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tmp_items </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> COMMIT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> DROP</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> AS</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        idx,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        COALESCE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((item</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;messageId&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)::uuid, gen_random_uuid()) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> message_id,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        COALESCE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(item</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;transactionId&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, gen_random_uuid()::</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">text</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> transaction_id,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        item</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;queue&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> queue_name,</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        -- ... more fields</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> jsonb_array_elements(p_items) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WITH</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ORDINALITY </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> t(item, idx);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    -- Ensure queues exist (batch upsert)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    INSERT INTO</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> queen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">queues</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, task)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    SELECT DISTINCT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> queue_name, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, task </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tmp_items</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> CONFLICT (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) DO NOTHING;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    -- Ensure partitions exist (batch upsert)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    INSERT INTO</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> queen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">partitions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (queue_id, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    SELECT DISTINCT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> q</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">partition_name</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tmp_items t</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    JOIN</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> queen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">queues</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> q </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> q</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">queue_name</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> CONFLICT (queue_id, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) DO NOTHING;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    -- Handle duplicates, insert messages, return results...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">END</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$$;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>Key benefits:</p><ul><li><strong>Single round-trip</strong> for any number of messages</li><li><strong>Automatic queue/partition creation</strong> with upserts</li><li><strong>Duplicate detection</strong> using transaction IDs</li><li><strong>All-or-nothing semantics</strong> within a transaction</li></ul><h3 id="pop-messages-unified-batch" tabindex="-1">Pop Messages (Unified Batch) <a class="header-anchor" href="#pop-messages-unified-batch" aria-label="Permalink to &quot;Pop Messages (Unified Batch)&quot;">​</a></h3><p>The <code>queen.pop_unified_batch</code> procedure handles both specific partition pops and wildcard discovery in a single call:</p><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE OR REPLACE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FUNCTION</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> queen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.pop_unified_batch(p_requests JSONB)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RETURNS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> JSONB</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">LANGUAGE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> plpgsql</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $$</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">BEGIN</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    FOR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> v_req </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">IN</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> jsonb_array_elements(p_requests)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    LOOP</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        IF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> v_is_wildcard </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">THEN</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            -- WILDCARD: Discover available partition with SKIP LOCKED</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            SELECT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> pl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">partition_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">p</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            INTO</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> v_partition_id, v_partition_name, ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            FROM</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> queen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">partition_lookup</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pl</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            JOIN</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> queen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">partitions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> p </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> p</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> pl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">partition_id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            LEFT JOIN</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> queen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">partition_consumers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pc </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> pc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">partition_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> pl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">partition_id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            WHERE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> pl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">queue_name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> v_req</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">queue_name</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">              AND</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">pc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">lease_expires_at</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> IS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> NULL</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> OR</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> pc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">lease_expires_at</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> v_now)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            ORDER BY</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> pc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">last_consumed_at</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ASC</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> NULLS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FIRST</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            LIMIT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            FOR</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> UPDATE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> OF pl </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SKIP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> LOCKED;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Critical for concurrent access</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        ELSE</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            -- SPECIFIC: Direct partition lookup</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            SELECT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> p</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ... </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> queen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">partitions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> p </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ...;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        END</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> IF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        -- Acquire lease, fetch messages, cleanup...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    END</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> LOOP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    RETURN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> v_results;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">END</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$$;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>Key features:</p><ul><li><strong>SKIP LOCKED</strong> for wildcard discovery prevents race conditions</li><li><strong>Lease management</strong> integrated into the same call</li><li><strong>Fair distribution</strong> via ordering by <code>last_consumed_at</code></li><li><strong>Auto-acknowledge</strong> option for QoS 0 delivery</li></ul><h2 id="long-polling-with-exponential-backoff" tabindex="-1">Long Polling with Exponential Backoff <a class="header-anchor" href="#long-polling-with-exponential-backoff" aria-label="Permalink to &quot;Long Polling with Exponential Backoff&quot;">​</a></h2><p>When a client calls <code>POP</code> with <code>wait=true</code>, Queen uses intelligent polling with exponential backoff:</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Initial:    100ms wait</span></span>
<span class="line"><span>Attempt 2:  100ms wait  </span></span>
<span class="line"><span>Attempt 3:  100ms wait</span></span>
<span class="line"><span>Attempt 4:  300ms wait (backoff kicks in)</span></span>
<span class="line"><span>Attempt 5:  900ms wait</span></span>
<span class="line"><span>Attempt 6:  2700ms wait</span></span>
<span class="line"><span>...</span></span>
<span class="line"><span>Maximum:    5000ms wait</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="how-backoff-works" tabindex="-1">How Backoff Works <a class="header-anchor" href="#how-backoff-works" aria-label="Permalink to &quot;How Backoff Works&quot;">​</a></h3><ol><li><strong>First few attempts</strong> — Poll at initial interval (100ms)</li><li><strong>After threshold</strong> — Backoff multiplier kicks in (3×)</li><li><strong>Cap at maximum</strong> — Never wait more than 5 seconds</li><li><strong>Reset on activity</strong> — When messages arrive or push happens, backoff resets</li></ol><div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Backoff calculation in libqueen</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (job.backoff_count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _pop_wait_backoff_threshold) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    next_interval </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> initial_interval </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> backoff_count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> backoff_multiplier;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (next_interval </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> max_interval) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        next_interval </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> max_interval;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    next_interval </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> initial_interval;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="wake-up-on-push" tabindex="-1">Wake-Up on Push <a class="header-anchor" href="#wake-up-on-push" aria-label="Permalink to &quot;Wake-Up on Push&quot;">​</a></h3><p>When a PUSH completes, libqueen wakes up waiting consumers for that queue/partition:</p><div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// After successful PUSH</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">_update_pop_backoff_tracker</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(queue_name, partition_name);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>This resets the backoff timer and immediately checks for messages, providing low-latency delivery.</p><h2 id="request-flow-examples" tabindex="-1">Request Flow Examples <a class="header-anchor" href="#request-flow-examples" aria-label="Permalink to &quot;Request Flow Examples&quot;">​</a></h2><h3 id="push-flow" tabindex="-1">PUSH Flow <a class="header-anchor" href="#push-flow" aria-label="Permalink to &quot;PUSH Flow&quot;">​</a></h3><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>1. Client sends HTTP POST to /api/v1/push</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>2. Acceptor routes to Worker (round-robin)</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>3. Worker parses JSON, registers in ResponseRegistry</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>4. Worker queues request to libqueen</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>5. libqueen batch timer fires (every 5ms)</span></span>
<span class="line"><span>   Groups all pending PUSH requests into single JSONB</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>6. libqueen calls: SELECT queen.push_messages_v2($1::jsonb)</span></span>
<span class="line"><span>   PQsendQueryParams() (non-blocking)</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>7. uv_poll monitors socket for response</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>8. Result ready → parse JSONB → dispatch by idx → deliver to workers</span></span>
<span class="line"><span>   uWS::Loop::defer() (thread-safe)</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>9. Worker sends HTTP 201 response</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Total time: 5-15ms (typical)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="pop-flow" tabindex="-1">POP Flow <a class="header-anchor" href="#pop-flow" aria-label="Permalink to &quot;POP Flow&quot;">​</a></h3><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>1. Client sends GET to /api/v1/pop?queue=orders</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>2. Worker registers in ResponseRegistry</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>3. Worker queues request to libqueen</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>4. libqueen batch timer fires (every 5ms)</span></span>
<span class="line"><span>   Groups all pending POP requests into single JSONB</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>5. Single call: SELECT queen.pop_unified_batch($1::jsonb)</span></span>
<span class="line"><span>   PostgreSQL handles atomically:</span></span>
<span class="line"><span>     - Acquire leases (SKIP LOCKED for wildcards)</span></span>
<span class="line"><span>     - Fetch messages after cursor</span></span>
<span class="line"><span>     - Release lease if empty</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>6. Results returned as JSONB array with idx for each request</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>7. libqueen dispatches each result to matching callback</span></span>
<span class="line"><span>   uWS::Loop::defer() (thread-safe)</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>8. Worker sends HTTP response</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Total time: 3-10ms (typical)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h2 id="connection-management" tabindex="-1">Connection Management <a class="header-anchor" href="#connection-management" aria-label="Permalink to &quot;Connection Management&quot;">​</a></h2><h3 id="connection-pools" tabindex="-1">Connection Pools <a class="header-anchor" href="#connection-pools" aria-label="Permalink to &quot;Connection Pools&quot;">​</a></h3><p>Each libqueen instance maintains its own pool of PostgreSQL connections:</p><div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// DBConnection structure</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> DBConnection</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    PGconn</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> conn </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nullptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // PostgreSQL connection</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> socket_fd </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          // Socket file descriptor</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    uv_poll_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> poll_handle;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       // libuv poll handle</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    std</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::vector</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PendingJob</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> jobs;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // Jobs using this connection</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="automatic-reconnection" tabindex="-1">Automatic Reconnection <a class="header-anchor" href="#automatic-reconnection" aria-label="Permalink to &quot;Automatic Reconnection&quot;">​</a></h3><p>libqueen runs a background reconnection thread that:</p><ol><li>Checks for dead connections every second</li><li>Reconnects in the background (non-blocking)</li><li>Signals the event loop to initialize poll handles</li><li>Returns the connection to the pool</li></ol><div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> _reconnect_loop</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (_reconnect_running) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        std</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">this_thread</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sleep_for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">std</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chrono</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">seconds</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">auto&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> slot : _db_connections) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (slot.conn </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nullptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">_reconnect_slot_db</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(slot)) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    slot.needs_poll_init </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                    uv_async_send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">_reconnect_signal);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="inter-instance-communication-udp" tabindex="-1">Inter-Instance Communication (UDP) <a class="header-anchor" href="#inter-instance-communication-udp" aria-label="Permalink to &quot;Inter-Instance Communication (UDP)&quot;">​</a></h2><p>In clustered deployments, Queen servers notify each other when messages are pushed or partitions become free:</p><table tabindex="0"><thead><tr><th>Event</th><th>Notification</th><th>Effect</th></tr></thead><tbody><tr><td>PUSH (message queued)</td><td><code>MESSAGE_AVAILABLE</code></td><td>Wake waiting consumers</td></tr><tr><td>ACK (partition freed)</td><td><code>PARTITION_FREE</code></td><td>Wake consumers for partition</td></tr></tbody></table><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> QUEEN_UDP_PEERS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;queen-b:6633,queen-c:6633&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> QUEEN_UDP_NOTIFY_PORT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">6633</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>When Server A pushes a message, it sends a UDP notification to Servers B and C. Those servers immediately wake up any consumers waiting for that queue, resetting their backoff timers.</p><h2 id="database-schema-highlights" tabindex="-1">Database Schema Highlights <a class="header-anchor" href="#database-schema-highlights" aria-label="Permalink to &quot;Database Schema Highlights&quot;">​</a></h2><h3 id="partition-consumers-table" tabindex="-1">Partition Consumers Table <a class="header-anchor" href="#partition-consumers-table" aria-label="Permalink to &quot;Partition Consumers Table&quot;">​</a></h3><p>Tracks the consumption state for each partition/consumer-group combination:</p><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> queen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.partition_consumers (</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    partition_id UUID,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    consumer_group </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">VARCHAR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">255</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    last_consumed_id UUID,           </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Cursor: last message ID</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    last_consumed_created_at </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TIMESTAMPTZ</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Cursor: last message timestamp</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    lease_expires_at </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TIMESTAMPTZ</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,    </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- When current lease expires</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    worker_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">VARCHAR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">255</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),          </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Which worker holds the lease</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    batch_size </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">INTEGER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,              </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Expected batch size</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    acked_count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">INTEGER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,             </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Messages acknowledged so far</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    UNIQUE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(partition_id, consumer_group)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="partition-lookup-table" tabindex="-1">Partition Lookup Table <a class="header-anchor" href="#partition-lookup-table" aria-label="Permalink to &quot;Partition Lookup Table&quot;">​</a></h3><p>Maintains a fast lookup for partition discovery:</p><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> queen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.partition_lookup (</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    queue_name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">VARCHAR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">255</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    partition_id UUID,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    last_message_id UUID,            </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Latest message in partition</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    last_message_created_at </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TIMESTAMPTZ</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    UNIQUE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(queue_name, partition_id)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>This table is updated by a trigger on message inserts, enabling O(1) partition discovery.</p><h2 id="performance-characteristics" tabindex="-1">Performance Characteristics <a class="header-anchor" href="#performance-characteristics" aria-label="Permalink to &quot;Performance Characteristics&quot;">​</a></h2><table tabindex="0"><thead><tr><th>Metric</th><th>Value</th></tr></thead><tbody><tr><td>PUSH sustained</td><td>130K+ msg/s (batched)</td></tr><tr><td>POP sustained</td><td>50K+ ops/s</td></tr><tr><td>Single message</td><td>10K+ msg/s (no client batching)</td></tr><tr><td>PUSH latency</td><td>5-15ms</td></tr><tr><td>POP latency</td><td>3-10ms</td></tr></tbody></table><h2 id="configuration-reference" tabindex="-1">Configuration Reference <a class="header-anchor" href="#configuration-reference" aria-label="Permalink to &quot;Configuration Reference&quot;">​</a></h2><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Server</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PORT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">6632</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> NUM_WORKERS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># libqueen (primary operations)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SIDECAR_POOL_SIZE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">50</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">              # Connections per worker</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SIDECAR_MICRO_BATCH_WAIT_MS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     # Batching window</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SIDECAR_MAX_ITEMS_PER_TX</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1000</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     # Max items per transaction</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Long polling</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SIDECAR_POP_WAIT_INITIAL_MS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">100</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   # Initial poll interval</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SIDECAR_POP_WAIT_BACKOFF_THRESHOLD</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # Attempts before backoff</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SIDECAR_POP_WAIT_BACKOFF_MULTIPLIER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3.0</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SIDECAR_POP_WAIT_MAX_MS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5000</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      # Maximum poll interval</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Inter-instance (clustered)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> QUEEN_UDP_PEERS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;queen-b:6633,queen-c:6633&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> QUEEN_UDP_NOTIFY_PORT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">6633</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h2 id="see-also" tabindex="-1">See Also <a class="header-anchor" href="#see-also" aria-label="Permalink to &quot;See Also&quot;">​</a></h2><ul><li><a href="/queen/server/architecture.html">Architecture</a> — System overview diagram</li><li><a href="/queen/server/environment-variables.html">Environment Variables</a> — Complete configuration reference</li><li><a href="/queen/server/tuning.html">Performance Tuning</a> — Optimization guide</li><li><a href="/queen/guide/failover.html">Failover &amp; Recovery</a> — Zero message loss guarantees</li></ul>`,95)])])}const b=a(l,[["render",p]]);export{d as __pageData,b as default};
