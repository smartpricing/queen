name: C++ Server Build

on:
  push:
    branches: [ "release" ]
  pull_request:
    branches: [ "release" ]

jobs:
  build-linux-amd64:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libpq-dev libssl-dev zlib1g-dev curl unzip jq
    
    - name: Extract version info
      id: version
      run: |
        VERSION=$(cat server/server.json | jq -r '.version')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version $VERSION"
    
    - name: Build queen-server
      working-directory: server
      run: |
        make deps
        make build-only
        strip bin/queen-server
        file bin/queen-server
        ls -lh bin/queen-server
    
    - name: Create tarball
      run: |
        cd server
        tar -czf queen-server-${{ steps.version.outputs.version }}-linux-amd64.tar.gz \
          bin/queen-server \
          README.md \
          ENV_VARIABLES.md
        mv queen-server-${{ steps.version.outputs.version }}-linux-amd64.tar.gz ../
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: queen-server-linux-amd64
        path: queen-server-${{ steps.version.outputs.version }}-linux-amd64.tar.gz
        retention-days: 30

  build-linux-arm64:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Install jq
      run: sudo apt-get update && sudo apt-get install -y jq
    
    - name: Extract version info
      id: version
      run: |
        VERSION=$(cat server/server.json | jq -r '.version')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version $VERSION"
    
    - name: Build ARM64 binary in Docker
      run: |
        docker run --platform linux/arm64 --rm \
          -v $PWD/server:/build \
          -w /build \
          ubuntu:24.04 bash -c "
            apt-get update && \
            apt-get install -y build-essential libpq-dev libssl-dev zlib1g-dev curl unzip file && \
            make deps && \
            make build-only && \
            strip bin/queen-server && \
            file bin/queen-server && \
            ls -lh bin/queen-server
          "
    
    - name: Create tarball
      run: |
        cd server
        tar -czf queen-server-${{ steps.version.outputs.version }}-linux-arm64.tar.gz \
          bin/queen-server \
          README.md \
          ENV_VARIABLES.md
        mv queen-server-${{ steps.version.outputs.version }}-linux-arm64.tar.gz ../
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: queen-server-linux-arm64
        path: queen-server-${{ steps.version.outputs.version }}-linux-arm64.tar.gz
        retention-days: 30

  summary:
    needs: [build-linux-amd64, build-linux-arm64]
    runs-on: ubuntu-latest
    
    steps:
    - name: Build summary
      run: |
        echo "âœ… C++ Server Build Complete"
        echo ""
        echo "Built for platforms:"
        echo "  - Linux AMD64"
        echo "  - Linux ARM64"
        echo ""
        echo "Artifacts are available for download for 30 days."

